<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phong Thủy Nhà Ở</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; color: #333; }
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); }
        .results { display: none; }
        .results.show { display: block; }
        .result-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .result-card h2 { color: #667eea; margin-bottom: 15px; font-size: 1.8em; }
        .result-card h3 { color: #764ba2; margin-top: 20px; margin-bottom: 10px; font-size: 1.3em; }
        .result-card h4 { color: #555; margin-top: 15px; margin-bottom: 8px; font-size: 1.1em; }
        .info-box {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .detail-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .highlight { background: #fff3cd; padding: 3px 8px; border-radius: 4px; font-weight: 600; }
        .element-tag {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin: 5px;
        }
        .kim { background: #ffd700; color: #333; }
        .moc { background: #228B22; color: white; }
        .thuy { background: #1E90FF; color: white; }
        .hoa { background: #FF4500; color: white; }
        .tho { background: #8B4513; color: white; }
        .direction-note {
            font-size: 0.95em;
            color: #666;
            font-style: italic;
            margin-top: 8px;
        }
        .compass-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        .quai-label {
            font-size: 14px;
            font-weight: bold;
            fill: #333;
        }
        /* CSS cho la bàn điện tử tích hợp */
        .compass-live-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .compass-live-widget h4 {
            color: white;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }
        
        .compass-live-display {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }
        
        .compass-container-live {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .compass-device {
            position: relative;
            width: 220px;
            height: 220px;
            flex-shrink: 0;
        }
        
        .compass-device-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15), inset 0 2px 8px rgba(255, 255, 255, 0.5);
            position: relative;
            transition: transform 0.3s ease-out;
        }
        
        .compass-device-inner {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            bottom: 12px;
            border-radius: 50%;
            background: white;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .compass-device-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: #667eea;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
            z-index: 10;
        }
        
        .compass-device-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 80px;
            margin-left: -2px;
            margin-top: -70px;
            background: linear-gradient(to bottom, #e74c3c 0%, #e74c3c 50%, #95a5a6 50%, #95a5a6 100%);
            border-radius: 2px;
            transform-origin: 2px 70px;
            transition: transform 0.3s ease-out;
            z-index: 5;
        }
        
        .compass-device-needle::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-bottom: 14px solid #e74c3c;
        }
        
        .compass-device-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .compass-device-label {
            position: absolute;
            font-weight: bold;
            color: #333;
        }
        
        .compass-device-label.n { 
            top: 12px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: #e74c3c; 
            font-size: 18px; 
        }
        .compass-device-label.e { 
            top: 50%; 
            right: 12px; 
            transform: translateY(-50%); 
            font-size: 15px; 
        }
        .compass-device-label.s { 
            bottom: 12px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 15px; 
        }
        .compass-device-label.w { 
            top: 50%; 
            left: 12px; 
            transform: translateY(-50%); 
            font-size: 15px; 
        }
        
        .compass-info-live {
            flex: 1;
            min-width: 250px;
        }
        
        .compass-degree-live {
            font-size: 56px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .compass-direction-live {
            font-size: 24px;
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .compass-btn-live {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 0 auto 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .compass-btn-live:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .compass-btn-live:active {
            transform: translateY(0);
        }
        
        .compass-status-live {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
            padding: 8px;
            background: #f5f7fa;
            border-radius: 6px;
        }
        
        .compass-error-live {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            text-align: center;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .compass-use-direction-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 15px auto 0;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        }
        
        .compass-use-direction-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .compass-use-direction-btn:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            /* Header */
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 14px;
            }
            
            /* Container padding */
            body {
                padding: 10px;
            }
            
            .container {
                padding: 0;
            }
            
            /* Card padding */
            .card {
                padding: 20px 15px;
                margin-bottom: 15px;
            }
            
            /* Input section */
            .input-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Form elements */
            input, select {
                font-size: 16px; /* Quan trọng: tránh zoom khi focus trên iOS */
                padding: 14px 12px;
            }
            
            label {
                font-size: 15px;
            }
            
            /* Button */
            .btn {
                padding: 14px 30px;
                font-size: 16px;
            }
            
            /* Result cards */
            .result-card {
                padding: 20px 15px;
                margin-bottom: 15px;
            }
            
            .result-card h2 {
                font-size: 1.5em;
                margin-bottom: 12px;
            }
            
            .result-card h3 {
                font-size: 1.2em;
                margin-top: 15px;
                margin-bottom: 8px;
            }
            
            .result-card h4 {
                font-size: 1em;
                margin-top: 12px;
                margin-bottom: 8px;
            }
            
            /* Info boxes */
            .info-box {
                padding: 12px;
                font-size: 14px;
            }
            
            .detail-box {
                padding: 12px;
                font-size: 14px;
            }
            
            .detail-box ul {
                margin-left: 15px;
            }
            
            .detail-box ul li {
                font-size: 13px;
                margin-bottom: 5px;
            }
            
            /* Highlight text */
            .highlight {
                font-size: 13px;
                padding: 2px 6px;
            }
            
            /* Element tags */
            .element-tag {
                padding: 6px 15px;
                font-size: 14px;
                margin: 3px;
            }
            
            /* Direction note */
            .direction-note {
                font-size: 12px;
            }
            
            /* ========== LA BÀN ĐIỆN TỬ - MOBILE ========== */
            
            /* La bàn live widget */
            .compass-live-widget {
                padding: 15px;
                margin: 15px 0;
            }
            
            .compass-live-widget h4 {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .compass-live-display {
                padding: 15px;
            }
            
            .compass-container-live {
                flex-direction: column;
                gap: 20px;
            }
            
            /* La bàn device - nhỏ hơn trên mobile */
            .compass-device {
                width: 180px;
                height: 180px;
            }
            
            .compass-device-circle {
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15), inset 0 2px 5px rgba(255, 255, 255, 0.5);
            }
            
            .compass-device-inner {
                top: 10px;
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
            
            .compass-device-center {
                width: 15px;
                height: 15px;
            }
            
            .compass-device-needle {
                width: 3px;
                height: 65px;
                margin-left: -1.5px;
                margin-top: -55px;
                transform-origin: 1.5px 55px;
            }
            
            .compass-device-needle::before {
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-bottom: 10px solid #e74c3c;
                top: -8px;
            }
            
            .compass-device-label.n {
                font-size: 16px;
                top: 8px;
            }
            
            .compass-device-label.e,
            .compass-device-label.s,
            .compass-device-label.w {
                font-size: 13px;
            }
            
            .compass-device-label.e {
                right: 8px;
            }
            
            .compass-device-label.s {
                bottom: 8px;
            }
            
            .compass-device-label.w {
                left: 8px;
            }
            
            /* Info live */
            .compass-info-live {
                min-width: 100%;
            }
            
            .compass-degree-live {
                font-size: 42px;
                margin-bottom: 8px;
            }
            
            .compass-direction-live {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            /* Buttons */
            .compass-btn-live {
                padding: 12px 25px;
                font-size: 15px;
                margin-bottom: 8px;
                width: 100%;
                max-width: 300px;
            }
            
            .compass-use-direction-btn {
                padding: 10px 20px;
                font-size: 14px;
                margin: 12px auto 0;
                width: 100%;
                max-width: 300px;
            }
            
            /* Status */
            .compass-status-live {
                font-size: 13px;
                padding: 8px 6px;
            }
            
            .compass-error-live {
                font-size: 12px;
                padding: 10px 8px;
            }
            
            /* ========== LA BÀN TĨNH SVG - MOBILE ========== */
            
            .compass-section {
                gap: 15px;
                margin: 15px 0;
            }
            
            /* SVG compass scaling */
            .compass-section > div {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .compass-section svg {
                width: 100% !important;
                height: auto !important;
                max-width: 400px;
                display: block;
                margin: 0 auto;
            }
            
            /* Quẻ labels trong SVG */
            .quai-label {
                font-size: 12px;
            }
        }
        /* ========================================
           THÊM RESPONSIVE CHO MOBILE NHỎ HƠN
           Thêm tiếp sau phần @media (max-width: 768px)
        ======================================== */
        
        @media (max-width: 480px) {
            /* Header nhỏ hơn */
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 13px;
            }
            
            /* Card padding nhỏ hơn */
            .card {
                padding: 15px 10px;
                border-radius: 15px;
            }
            
            /* Result card */
            .result-card {
                padding: 15px 10px;
                border-radius: 12px;
            }
            
            .result-card h2 {
                font-size: 1.3em;
            }
            
            .result-card h3 {
                font-size: 1.1em;
            }
            
            .result-card h4 {
                font-size: 0.95em;
            }
            
            /* Info boxes */
            .info-box,
            .detail-box {
                padding: 10px;
                font-size: 13px;
            }
            
            .detail-box ul li {
                font-size: 12px;
            }
            
            /* La bàn device - nhỏ nhất */
            .compass-device {
                width: 160px;
                height: 160px;
            }
            
            .compass-device-needle {
                width: 2.5px;
                height: 55px;
                margin-left: -1.25px;
                margin-top: -48px;
                transform-origin: 1.25px 48px;
            }
            
            .compass-device-needle::before {
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-bottom: 8px solid #e74c3c;
            }
            
            .compass-device-label.n {
                font-size: 14px;
            }
            
            .compass-device-label.e,
            .compass-device-label.s,
            .compass-device-label.w {
                font-size: 11px;
            }
            
            /* Degrees */
            .compass-degree-live {
                font-size: 36px;
            }
            
            .compass-direction-live {
                font-size: 16px;
            }
            
            /* Buttons nhỏ hơn */
            .compass-btn-live {
                padding: 11px 20px;
                font-size: 14px;
            }
            
            .compass-use-direction-btn {
                padding: 9px 18px;
                font-size: 13px;
            }
            
            /* SVG compass */
            .compass-section svg {
                max-width: 320px;
            }
        }
        
        /* ========================================
           THÊM: TOUCH-FRIENDLY IMPROVEMENTS
           Cải thiện trải nghiệm touch trên mobile
        ======================================== */
        
        @media (max-width: 768px) {
            /* Tăng kích thước vùng chạm cho buttons */
            .btn,
            .compass-btn-live,
            .compass-use-direction-btn {
                min-height: 44px; /* iOS recommended touch target */
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            }
            
            /* Select và input dễ chạm hơn */
            input,
            select {
                min-height: 44px;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Smooth scrolling */
            html {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Tránh text selection khi double tap */
            .compass-device,
            .compass-info-live {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            /* SVG text dễ đọc hơn */
            svg text {
                pointer-events: none;
            }
        }
        
        /* ========================================
           LANDSCAPE MODE (Chế độ ngang)
        ======================================== */
        
        @media (max-width: 768px) and (orientation: landscape) {
            .compass-container-live {
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }
            
            .compass-device {
                width: 150px;
                height: 150px;
            }
            
            .compass-info-live {
                min-width: 200px;
            }
            
            .compass-degree-live {
                font-size: 36px;
            }
            
            .compass-direction-live {
                font-size: 16px;
            }
        }
        /* ========== LA BÀN TƯƠNG TÁC TÍCH HỢP SVG ========== */
        .compass-svg-container {
            position: relative;
            width: 100%;
            max-width: 750px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #interactiveCompassSVG {
            transition: transform 0.3s ease-out;
        }
        
        /* Kim la bàn ẩn mặc định */
        #interactiveCompassNeedle {
            opacity: 0 !important;
        }
        
        #interactiveCompassNeedle.active {
            opacity: 1 !important;
        }
        
        /* Label độ trên mũi tên */
        #compassDegreeLabel {
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        #compassDegreeLabel.active {
            opacity: 1;
        }
        
        /* Nút điều khiển la bàn */
        .compass-controls-bottom {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .compass-btn-control {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 200px;
        }
        
        .compass-btn-activate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .compass-btn-activate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .compass-btn-activate.active {
            background: #4CAF50;
        }
        
        .compass-btn-apply {
            background: #4CAF50;
            color: white;
        }
        
        .compass-btn-apply:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .compass-btn-control:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }
        
        .compass-error-msg {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .compass-controls-bottom {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .compass-btn-control {
                width: 100%;
                max-width: 300px;
                min-width: unset;
                padding: 12px 25px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .compass-btn-control {
                padding: 11px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 Phong Thủy Nhà Ở 🏠</h1>
            <p>Bố trí nhà cửa theo phong thủy Đông phương</p>
        </div>

        <div class="card">
            <div class="input-section">
                <div class="form-group">
                    <label for="year">Năm sinh (Dương lịch):</label>
                    <input type="number" id="year" placeholder="Năm sinh" min="1900" max="2100">
                </div>
                <div class="form-group">
                    <label for="gender">Giới tính:</label>
                    <select id="gender">
                        <option value="">Chọn giới tính</option>
                        <option value="nam">Nam</option>
                        <option value="nu">Nữ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="doorDir">Hướng cửa chính:</label>
                    <select id="doorDir">
                        <option value="">Chọn hướng</option>
                        <option value="Bắc">Bắc</option>
                        <option value="Đông Bắc">Đông Bắc</option>
                        <option value="Đông">Đông</option>
                        <option value="Đông Nam">Đông Nam</option>
                        <option value="Nam">Nam</option>
                        <option value="Tây Nam">Tây Nam</option>
                        <option value="Tây">Tây</option>
                        <option value="Tây Bắc">Tây Bắc</option>
                    </select>
                </div>
            </div>
            <div id="error-message" style="color: #f44336; font-weight: bold; margin-top: 10px; display: none;"></div>
            <button class="btn" onclick="calculateFengShui()">Xem</button>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        const DATA = {
            menh: {
                'Kim': { colors: 'Trắng, Vàng, Nâu, Xám bạc', items: 'Đồ kim loại (đồng hồ, tượng đồng), chuông gió kim loại, tranh núi đá', plants: 'Kim ngân, lưỡi hổ, cây lá bạc', stones: 'Thạch anh trắng, kim sa, hổ phách trắng', element: 'kim' },
                'Mộc': { colors: 'Xanh lá cây, Xanh lam, Đen, Xanh ngọc', items: 'Đồ gỗ tự nhiên, tranh cây cối, tượng gỗ, bonsai', plants: 'Cây phát tài, trúc, phú quý, cây xanh tươi tốt', stones: 'Ngọc bích, mã não xanh, emerald', element: 'moc' },
                'Thủy': { colors: 'Đen, Xám, Xanh dương đậm, Xanh navy', items: 'Bể cá, thác nước mini, tranh biển, đài phun nước', plants: 'Cây thủy sinh, sen đá, trầu bà nước, lan ý', stones: 'Thạch anh đen, obsidian, lapis lazuli', element: 'thuy' },
                'Hỏa': { colors: 'Đỏ, Cam, Hồng, Tím, Đỏ tươi', items: 'Đèn trang trí, nến thơm, tranh mặt trời, đồ điện tử', plants: 'Hoa hồng, phượng, cây lá đỏ, hoa đỏ', stones: 'Mã não đỏ, hồng ngọc, garnet', element: 'hoa' },
                'Thổ': { colors: 'Vàng, Nâu đất, Cam đất, Be', items: 'Đồ gốm sứ, đá tự nhiên, tượng Phật đất nung, lư hương', plants: 'Xương rồng, sen đá, cây đa, cây lá dày', stones: 'Thạch anh vàng, hổ phách, citrine', element: 'tho' }
            },
            quai: {
                'Càn': { dirs: { good: ['Tây', 'Đông Bắc', 'Tây Nam', 'Tây Bắc'], bad: ['Nam', 'Đông', 'Bắc', 'Đông Nam'] }, group: 'Tây Tứ Trạch', explain: 'Quái Càn tượng trưng cho Trời, kim loại cứng rắn. Người mệnh Càn thích sự vững chắc, trật tự.' },
                'Đoài': { dirs: { good: ['Tây Bắc', 'Tây Nam', 'Đông Bắc', 'Tây'], bad: ['Đông', 'Nam', 'Đông Nam', 'Bắc'] }, group: 'Tây Tứ Trạch', explain: 'Quái Đoài tượng trưng cho Đầm lầy, kim loại mềm. Người mệnh Đoài vui vẻ, giao tiếp tốt.' },
                'Cấn': { dirs: { good: ['Tây Nam', 'Tây Bắc', 'Tây', 'Đông Bắc'], bad: ['Đông Nam', 'Bắc', 'Đông', 'Nam'] }, group: 'Tây Tứ Trạch', explain: 'Quái Cấn tượng trưng cho Núi, sự vững chắc. Người mệnh Cấn có tính bền bỉ, kiên định.' },
                'Khôn': { dirs: { good: ['Đông Bắc', 'Tây', 'Tây Bắc', 'Tây Nam'], bad: ['Bắc', 'Đông Nam', 'Nam', 'Đông'] }, group: 'Tây Tứ Trạch', explain: 'Quái Khôn tượng trưng cho Đất, sự bao dung. Người mệnh Khôn có tính kiên nhẫn, nuôi dưỡng.' },
                'Chấn': { dirs: { good: ['Nam', 'Bắc', 'Đông Nam', 'Đông'], bad: ['Tây', 'Tây Bắc', 'Đông Bắc', 'Tây Nam'] }, group: 'Đông Tứ Trạch', explain: 'Quái Chấn tượng trưng cho Sấm, sự chuyển động. Người mệnh Chấn năng động, quyết đoán.' },
                'Tốn': { dirs: { good: ['Bắc', 'Nam', 'Đông', 'Đông Nam'], bad: ['Đông Bắc', 'Tây Nam', 'Tây', 'Tây Bắc'] }, group: 'Đông Tứ Trạch', explain: 'Quái Tốn tượng trưng cho Gió, sự linh hoạt. Người mệnh Tốn khéo léo, thích nghi tốt.' },
                'Ly': { dirs: { good: ['Đông', 'Đông Nam', 'Bắc', 'Nam'], bad: ['Tây Bắc', 'Tây', 'Tây Nam', 'Đông Bắc'] }, group: 'Đông Tứ Trạch', explain: 'Quái Ly tượng trưng cho Lửa, ánh sáng. Người mệnh Ly nhiệt huyết, sáng tạo, nổi bật.' },
                'Khảm': { dirs: { good: ['Đông Nam', 'Đông', 'Nam', 'Bắc'], bad: ['Tây Nam', 'Đông Bắc', 'Tây Bắc', 'Tây'] }, group: 'Đông Tứ Trạch', explain: 'Quái Khảm tượng trưng cho Nước, sự thấu hiểu. Người mệnh Khảm thông minh, linh hoạt.' }
            }
        };

        let preciseDoorDegree = null;
        const STARS = ['Sinh Khí', 'Thiên Y', 'Diên Niên', 'Phục Vị'];
        const BAD_STARS = ['Tuyệt Mệnh', 'Ngũ Quỷ', 'Lục Sát', 'Họa Hại'];
        const STAR_DESC = ['Cực tốt - Vượng về tài lộc, sự nghiệp, con cái khỏe mạnh thông minh', 'Rất tốt - Sức khỏe dồi dào, gặp quý nhân phù trợ, bệnh tật tiêu tan', 'Tốt - Hôn nhân hạnh phúc, gia đạo hòa thuận, sống lâu', 'Khá tốt - Cuộc sống bình an, ổn định, không có biến cố lớn'];
        const BAD_DESC = ['Hung nhất - Tai họa lớn, nguy hiểm tính mạng, phá sản', 'Cực xấu - Bệnh tật nghiêm trọng, hỏa hoạn, mất mát lớn', 'Rất xấu - Tranh chấp pháp lý, kiện tụng, tiêu tán tài sản', 'Xấu - Dễ gặp tai nạn nhỏ, tranh cãi trong gia đình'];

        function calcMenh(y) {
            const napAm = [
                'Giáp Tý - Hải Trung Kim','Ất Sửu - Hải Trung Kim','Bính Dần - Lư Trung Hỏa','Đinh Mão - Lư Trung Hỏa','Mậu Thìn - Đại Lâm Mộc','Kỷ Tỵ - Đại Lâm Mộc',
                'Canh Ngọ - Lộ Bàng Thổ','Tân Mùi - Lộ Bàng Thổ','Nhâm Thân - Kiếm Phong Kim','Quý Dậu - Kiếm Phong Kim','Giáp Tuất - Sơn Đầu Hỏa','Ất Hợi - Sơn Đầu Hỏa',
                'Bính Tý - Giản Hạ Thủy','Đinh Sửu - Giản Hạ Thủy','Mậu Dần - Thành Đầu Thổ','Kỷ Mão - Thành Đầu Thổ','Canh Thìn - Bạch Lạp Kim','Tân Tỵ - Bạch Lạp Kim',
                'Nhâm Ngọ - Dương Liễu Mộc','Quý Mùi - Dương Liễu Mộc','Giáp Thân - Tuyền Trung Thủy','Ất Dậu - Tuyền Trung Thủy','Bính Tuất - Ốc Thượng Thổ','Đinh Hợi - Ốc Thượng Thổ',
                'Mậu Tý - Tích Lịch Hỏa','Kỷ Sửu - Tích Lịch Hỏa','Canh Dần - Tùng Bách Mộc','Tân Mão - Tùng Bách Mộc','Nhâm Thìn - Trường Lưu Thủy','Quý Tỵ - Trường Lưu Thủy',
                'Giáp Ngọ - Sa Trung Kim','Ất Mùi - Sa Trung Kim','Bính Thân - Sơn Hạ Hỏa','Đinh Dậu - Sơn Hạ Hỏa','Mậu Tuất - Bình Địa Mộc','Kỷ Hợi - Bình Địa Mộc',
                'Canh Tý - Bích Thượng Thổ','Tân Sửu - Bích Thượng Thổ','Nhâm Dần - Kim Bạch Kim','Quý Mão - Kim Bạch Kim','Giáp Thìn - Phúc Đăng Hỏa','Ất Tỵ - Phúc Đăng Hỏa',
                'Bính Ngọ - Thiên Hà Thủy','Đinh Mùi - Thiên Hà Thủy','Mậu Thân - Đại Trạch Thổ','Kỷ Dậu - Đại Trạch Thổ','Canh Tuất - Thoa Xuyến Kim','Tân Hợi - Thoa Xuyến Kim',
                'Nhâm Tý - Tang Đố Mộc','Quý Sửu - Tang Đố Mộc','Giáp Dần - Đại Khê Thủy','Ất Mão - Đại Khê Thủy','Bính Thìn - Sa Trung Thổ','Đinh Tỵ - Sa Trung Thổ',
                'Mậu Ngọ - Thiên Thượng Hỏa','Kỷ Mùi - Thiên Thượng Hỏa','Canh Thân - Thạch Lựu Mộc','Tân Dậu - Thạch Lựu Mộc','Nhâm Tuất - Đại Hải Thủy','Quý Hợi - Đại Hải Thủy'
            ];
            const baseYear = 1924;
            let index = (y - baseYear) % 60;
            if (index < 0) index += 60;
            return napAm[index];
        }

        function calcQuai(y, g) {
            let last = y % 100;
            let sum = Math.floor(last / 10) + (last % 10);
            while (sum > 9) sum = Math.floor(sum / 10) + (sum % 10);
            if (sum === 0) sum = 9;
            let n;
            if (y < 2000) {
                if (g === 'nam') {
                    n = 10 - sum;
                } else {
                    n = sum + 5;
                    if (n > 9) n -= 9;
                }
            } else {
                if (g === 'nam') {
                    n = 9 - sum;
                } else {
                    n = sum + 6;
                    if (n > 9) n -= 9;
                }
            }
            if (n === 5) n = g === 'nam' ? 2 : 8;
            if (n === 0) n = 9;
            const q = {1:'Khảm',2:'Khôn',3:'Chấn',4:'Tốn',6:'Càn',7:'Đoài',8:'Cấn',9:'Ly'};
            return q[n] || 'Khảm';
        }

        function drawCompass(q, doorDir, doorDeg = null) {
            const s = 750, cx = s/2, r1 = s/2-50;
            
            if (doorDeg === null && doorDir) {
                const directionToDegree = {
                    'Bắc': 0, 'Đông Bắc': 45, 'Đông': 90, 'Đông Nam': 135,
                    'Nam': 180, 'Tây Nam': 225, 'Tây': 270, 'Tây Bắc': 315
                };
                doorDeg = directionToDegree[doorDir];
            }
            
            // 24 hướng theo La Kinh
            const dirs24 = [
                {name: 'Tý', deg: 0, type: 'chi'},
                {name: 'Quý', deg: 15, type: 'can'},
                {name: 'Sửu', deg: 30, type: 'chi'},
                {name: 'Cấn', deg: 45, type: 'quai'},
                {name: 'Dần', deg: 60, type: 'chi'},
                {name: 'Giáp', deg: 75, type: 'can'},
                {name: 'Mão', deg: 90, type: 'chi'},
                {name: 'Ất', deg: 105, type: 'can'},
                {name: 'Thìn', deg: 120, type: 'chi'},
                {name: 'Tốn', deg: 135, type: 'quai'},
                {name: 'Tỵ', deg: 150, type: 'chi'},
                {name: 'Bính', deg: 165, type: 'can'},
                {name: 'Ngọ', deg: 180, type: 'chi'},
                {name: 'Đinh', deg: 195, type: 'can'},
                {name: 'Mùi', deg: 210, type: 'chi'},
                {name: 'Khôn', deg: 225, type: 'quai'},
                {name: 'Thân', deg: 240, type: 'chi'},
                {name: 'Canh', deg: 255, type: 'can'},
                {name: 'Dậu', deg: 270, type: 'chi'},
                {name: 'Tân', deg: 285, type: 'can'},
                {name: 'Tuất', deg: 300, type: 'chi'},
                {name: 'Càn', deg: 315, type: 'quai'},
                {name: 'Hợi', deg: 330, type: 'chi'},
                {name: 'Nhâm', deg: 345, type: 'can'}
            ];
            
            // 24 Sao Phúc Đức
            const phucDucStars = [
                {name: 'Phúc Đức', type: 'cat'}, {name: 'Ôn Hoàng', type: 'hung'},
                {name: 'Tấn Tài', type: 'cat'}, {name: 'Trường Bệnh', type: 'hung'},
                {name: 'Tố Tụng', type: 'hung'}, {name: 'Quan Tước', type: 'cat'},
                {name: 'Quan Quý', type: 'cat'}, {name: 'Tự Ải', type: 'hung'},
                {name: 'Vượng Trang', type: 'cat'}, {name: 'Hưng Phước', type: 'cat'},
                {name: 'Pháp Trường', type: 'hung'}, {name: 'Điên Cuồng', type: 'hung'},
                {name: 'Khẩu Thiệt', type: 'hung'}, {name: 'Vượng Tâm', type: 'cat'},
                {name: 'Tấn Điền', type: 'cat'}, {name: 'Khốc Khấp', type: 'hung'},
                {name: 'Cô Quả', type: 'hung'}, {name: 'Vinh Phú', type: 'cat'},
                {name: 'Thiếu Vong', type: 'hung'}, {name: 'Xương Dâm', type: 'hung'},
                {name: 'Thân Hôn', type: 'cat'}, {name: 'Hoan Lạc', type: 'cat'},
                {name: 'Bại Tuyệt', type: 'hung'}, {name: 'Vượng Tài', type: 'cat'}
            ];
            
            const phucDucStart = {
                'Khảm': 'Dần', 'Cấn': 'Giáp', 'Chấn': 'Tỵ', 'Tốn': 'Tỵ',
                'Ly': 'Thân', 'Khôn': 'Hợi', 'Đoài': 'Hợi', 'Càn': 'Thân'
            };
            
            const startPos = phucDucStart[q];
            const startIdx = dirs24.findIndex(d => d.name === startPos);
            
            const stars24 = dirs24.map((dir, i) => {
                const starIdx = (i - startIdx + 24) % 24;
                return {
                    ...phucDucStars[starIdx],
                    position: dir.name,
                    deg: dir.deg
                };
            });
            
            const mainDirs = [
                {name: 'Bắc', deg: 0, quai: 'Khảm'},
                {name: 'Đông Bắc', deg: 45, quai: 'Cấn'},
                {name: 'Đông', deg: 90, quai: 'Chấn'},
                {name: 'Đông Nam', deg: 135, quai: 'Tốn'},
                {name: 'Nam', deg: 180, quai: 'Ly'},
                {name: 'Tây Nam', deg: 225, quai: 'Khôn'},
                {name: 'Tây', deg: 270, quai: 'Đoài'},
                {name: 'Tây Bắc', deg: 315, quai: 'Càn'}
            ];
            
            const quaiColors = {
                'Khảm': '#1E90FF', 'Cấn': '#8B4513', 'Chấn': '#228B22', 'Tốn': '#90EE90',
                'Ly': '#FF4500', 'Khôn': '#DAA520', 'Đoài': '#FFD700', 'Càn': '#C0C0C0'
            };
            
            const rings = [
                { r: r1, label: '8 Hướng' },
                { r: r1 - 50, label: '24 Sao Phúc Đức' },
                { r: r1 - 100, label: '24 Cung' },
                { r: r1 - 150, label: 'Cát/Hung Tinh' },
                { r: r1 - 200, label: '8 Quẻ' }
            ];
            
            const goodDirs = DATA.quai[q].dirs.good;
            const badDirs = DATA.quai[q].dirs.bad;
            
            // Xác định cát/hung cho cửa chính
            let doorIsGood = false;
            let nearestDir = null;
            if (doorDeg !== null && doorDeg !== undefined) {
                let minDiff = 360;
                mainDirs.forEach(dir => {
                    let diff = Math.abs(doorDeg - dir.deg);
                    if (diff > 180) diff = 360 - diff;
                    if (diff < minDiff) {
                        minDiff = diff;
                        nearestDir = dir.name;
                    }
                });
                doorIsGood = goodDirs.includes(nearestDir);
            }
            
            // Bắt đầu HTML: Phần điều khiển la bàn tương tác
            let interactiveControls = `
            <div class="compass-interactive-section">
                <h4>🧭 LA BÀN ĐIỆN TỬ TƯƠNG TÁC</h4>
                <div class="compass-controls">
                    <div class="compass-info-display">
                        <div class="compass-current-heading" id="liveHeadingDisplay">0°</div>
                        <div class="compass-current-direction" id="liveDirectionDisplay">Bắc</div>
                        <div class="compass-status-text" id="compassStatusText">
                            Nhấn "Kích Hoạt La Bàn" để đo hướng cửa chính
                        </div>
                    </div>
                    <div class="compass-btn-group">
                        <button class="compass-activate-btn" id="activateCompassBtn">
                            🧭 Kích Hoạt La Bàn
                        </button>
                        <button class="compass-apply-btn" id="applyDirectionBtn" disabled>
                            ✓ Áp Dụng Hướng Này
                        </button>
                    </div>
                </div>
                <div class="compass-error-message hidden" id="compassErrorMsg"></div>
            </div>`;
            
            // SVG La bàn
            let svg = `<svg width="${s}" height="${s}" viewBox="0 0 ${s} ${s}" id="interactiveCompassSVG">`;
            
            // Gradient nền
            svg += `<defs>
                <radialGradient id="bgGrad">
                    <stop offset="0%" style="stop-color:#FFF8DC;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#F5DEB3;stop-opacity:1" />
                </radialGradient>
            </defs>`;
            svg += `<circle cx="${cx}" cy="${cx}" r="${r1}" fill="url(#bgGrad)"/>`;
            
            // Vẽ 5 vòng tròn
            rings.forEach((ring, idx) => {
                const strokeW = idx === 0 ? 4 : 2;
                svg += `<circle cx="${cx}" cy="${cx}" r="${ring.r}" fill="none" stroke="#333" stroke-width="${strokeW}"/>`;
            });
            
            // Vẽ màu nền Cát/Hung
            mainDirs.forEach((dir) => {
                const isGood = goodDirs.includes(dir.name);
                const a1 = (dir.deg - 22.5 - 90) * Math.PI / 180;
                const a2 = (dir.deg + 22.5 - 90) * Math.PI / 180;
                const sectorColor = isGood ? 'rgba(76, 175, 80, 0.2)' : 'rgba(244, 67, 54, 0.2)';
                
                const x1 = cx + Math.cos(a1) * rings[0].r;
                const y1 = cx + Math.sin(a1) * rings[0].r;
                const x2 = cx + Math.cos(a2) * rings[0].r;
                const y2 = cx + Math.sin(a2) * rings[0].r;
                const x3 = cx + Math.cos(a2) * rings[3].r;
                const y3 = cx + Math.sin(a2) * rings[3].r;
                const x4 = cx + Math.cos(a1) * rings[3].r;
                const y4 = cx + Math.sin(a1) * rings[3].r;
                
                svg += `<path d="M${x1} ${y1}A${rings[0].r} ${rings[0].r} 0 0 1 ${x2} ${y2}L${x3} ${y3}A${rings[3].r} ${rings[3].r} 0 0 0 ${x4} ${y4}Z" fill="${sectorColor}"/>`;
            });
            
            // Đường chia Cát/Hung
            mainDirs.forEach((dir) => {
                const a1 = (dir.deg - 22.5 - 90) * Math.PI / 180;
                const x1 = cx + Math.cos(a1) * r1;
                const y1 = cx + Math.sin(a1) * r1;
                svg += `<line x1="${cx}" y1="${cx}" x2="${x1}" y2="${y1}" stroke="#666" stroke-width="2"/>`;
            });
            
            // VÒNG 1: 8 Hướng chính
            mainDirs.forEach((dir) => {
                const isGood = goodDirs.includes(dir.name);
                const a = (dir.deg - 90) * Math.PI / 180;
                const tx1 = cx + Math.cos(a) * (r1 + 30);
                const ty1 = cx + Math.sin(a) * (r1 + 30);
                const dirColor = isGood ? '#008000' : '#C62828';
                svg += `<text x="${tx1}" y="${ty1}" text-anchor="middle" dominant-baseline="middle" font-size="15" font-weight="bold" fill="${dirColor}">${dir.name}</text>`;
            });
            
            // VÒNG 2: 24 Sao Phúc Đức
            stars24.forEach((star) => {
                const a = (star.deg - 90) * Math.PI / 180;
                const a1 = (star.deg - 7.5 - 90) * Math.PI / 180;
                
                const xInner = cx + Math.cos(a1) * rings[0].r;
                const yInner = cx + Math.sin(a1) * rings[0].r;
                const xOuter = cx + Math.cos(a1) * rings[1].r;
                const yOuter = cx + Math.sin(a1) * rings[1].r;
                svg += `<line x1="${xInner}" y1="${yInner}" x2="${xOuter}" y2="${yOuter}" stroke="#999" stroke-width="0.5"/>`;
                
                const tx2 = cx + Math.cos(a) * ((rings[0].r + rings[1].r) / 2);
                const ty2 = cx + Math.sin(a) * ((rings[0].r + rings[1].r) / 2);
                const starColor = star.type === 'cat' ? '#2E7D32' : '#C62828';
                svg += `<text x="${tx2}" y="${ty2}" text-anchor="middle" dominant-baseline="middle" font-size="12" font-weight="500" fill="${starColor}">${star.name}</text>`;
            });
            
            // VÒNG 3: 24 Cung
            dirs24.forEach((dir) => {
                const a = (dir.deg - 90) * Math.PI / 180;
                const a1 = (dir.deg - 7.5 - 90) * Math.PI / 180;
                
                const xInner = cx + Math.cos(a1) * rings[1].r;
                const yInner = cx + Math.sin(a1) * rings[1].r;
                const xOuter = cx + Math.cos(a1) * rings[2].r;
                const yOuter = cx + Math.sin(a1) * rings[2].r;
                svg += `<line x1="${xInner}" y1="${yInner}" x2="${xOuter}" y2="${yOuter}" stroke="#999" stroke-width="0.5"/>`;
                
                const tx3 = cx + Math.cos(a) * ((rings[1].r + rings[2].r) / 2);
                const ty3 = cx + Math.sin(a) * ((rings[1].r + rings[2].r) / 2);
                
                let txtColor = '#333';
                if (dir.type === 'quai') txtColor = '#8B0000';
                else if (dir.type === 'can') txtColor = '#00008B';
                
                svg += `<text x="${tx3}" y="${ty3}" text-anchor="middle" dominant-baseline="middle" font-size="12" font-weight="${dir.type === 'quai' ? 'bold' : 'normal'}" fill="${txtColor}">${dir.name}</text>`;
            });
            
            // VÒNG 4: Cát/Hung Tinh
            mainDirs.forEach((dir) => {
                const isGood = goodDirs.includes(dir.name);
                const a = (dir.deg - 90) * Math.PI / 180;
                const tx4 = cx + Math.cos(a) * ((rings[2].r + rings[3].r) / 2);
                const ty4 = cx + Math.sin(a) * ((rings[2].r + rings[3].r) / 2);
                
                const starIdx = isGood ? goodDirs.indexOf(dir.name) : badDirs.indexOf(dir.name);
                const star = isGood ? (starIdx >= 0 ? STARS[starIdx] : '') : (starIdx >= 0 ? BAD_STARS[starIdx] : '');
                const starColor = isGood ? '#2E7D32' : '#C62828';
                svg += `<text x="${tx4}" y="${ty4}" text-anchor="middle" dominant-baseline="middle" font-size="12" font-weight="600" fill="${starColor}">${star}</text>`;
            });
            
            // VÒNG 5: 8 Quẻ
            mainDirs.forEach((dir) => {
                const a = (dir.deg - 90) * Math.PI / 180;
                const tx5 = cx + Math.cos(a) * ((rings[3].r + rings[4].r) / 2);
                const ty5 = cx + Math.sin(a) * ((rings[3].r + rings[4].r) / 2);
                
                const qColor = quaiColors[dir.quai];
                svg += `<rect x="${tx5-20}" y="${ty5-9}" width="40" height="18" fill="${qColor}" opacity="0.7" rx="3"/>`;
                svg += `<text x="${tx5}" y="${ty5}" text-anchor="middle" dominant-baseline="middle" font-size="12" font-weight="bold" fill="#000">${dir.quai}</text>`;
            });
            
            // TRUNG TÂM: Tên Quẻ
            const centerR = 50;
            svg += `<circle cx="${cx}" cy="${cx}" r="${centerR}" fill="#FFF8DC" stroke="#8B4513" stroke-width="3"/>`;
            svg += `<text x="${cx}" y="${cx}" text-anchor="middle" dominant-baseline="middle" font-size="28" font-weight="bold" fill="#8B4513">${q}</text>`;
            
            // Vẽ độ số (0-360°)
            for (let deg = 0; deg < 360; deg++) {
                const a = (deg - 90) * Math.PI / 180;
                const xInner = cx + Math.cos(a) * (r1 - 5);
                const yInner = cx + Math.sin(a) * (r1 - 5);
                const xOuter = cx + Math.cos(a) * r1;
                const yOuter = cx + Math.sin(a) * r1;
                
                svg += `<line x1="${xInner}" y1="${yInner}" x2="${xOuter}" y2="${yOuter}" stroke="#666" stroke-width="0.3"/>`;
                
                if (deg % 10 === 0) {
                    const tx = cx + Math.cos(a) * (r1 + 15);
                    const ty = cx + Math.sin(a) * (r1 + 15);
                    svg += `<text x="${tx}" y="${ty}" text-anchor="middle" dominant-baseline="middle" font-size="9" fill="#444">${deg}°</text>`;
                }
            }
            
            // MŨI TÊN HƯỚNG CỬA (nếu có)
                if (doorDeg !== null && doorDeg !== undefined) {
                    const arrowAngle = (doorDeg - 90) * Math.PI / 180;
                    const arrowColor = doorIsGood ? '#00C853' : '#FF1744';
                    const arrowWidth = 6;
                    
                    const startX = cx + Math.cos(arrowAngle) * 60;
                    const startY = cx + Math.sin(arrowAngle) * 60;
                    const endX = cx + Math.cos(arrowAngle) * (r1 - 215);
                    const endY = cx + Math.sin(arrowAngle) * (r1 - 215);
                    
                    svg += `<line x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" stroke="${arrowColor}" stroke-width="${arrowWidth}" stroke-linecap="round" opacity="0.9"/>`;
                    
                    const arrowHeadLength = 18;
                    const arrowHeadAngle = 25 * Math.PI / 180;
                    const leftX = endX - arrowHeadLength * Math.cos(arrowAngle - arrowHeadAngle);
                    const leftY = endY - arrowHeadLength * Math.sin(arrowAngle - arrowHeadAngle);
                    const rightX = endX - arrowHeadLength * Math.cos(arrowAngle + arrowHeadAngle);
                    const rightY = endY - arrowHeadLength * Math.sin(arrowAngle + arrowHeadAngle);
                    
                    svg += `<polygon points="${endX},${endY} ${leftX},${leftY} ${rightX},${rightY}" fill="${arrowColor}" opacity="0.9"/>`;
                    
                    const labelX = cx + Math.cos(arrowAngle) * (r1 + 45);
                    const labelY = cx + Math.sin(arrowAngle) * (r1 + 45);
                    
                    svg += `<circle cx="${labelX}" cy="${labelY}" r="28" fill="${arrowColor}" opacity="0.95" stroke="white" stroke-width="2"/>`;
                    svg += `<text x="${labelX}" y="${labelY - 6}" text-anchor="middle" dominant-baseline="middle" font-size="13" font-weight="bold" fill="#FFF">${doorDeg}°</text>`;
                    svg += `<text x="${labelX}" y="${labelY + 9}" text-anchor="middle" dominant-baseline="middle" font-size="10" font-weight="bold" fill="#FFF">${doorIsGood ? 'CÁT' : 'HUNG'}</text>`;
                }
                
                
                svg += `</svg>`;
            // Chú thích
                const legend = `
                    <div style="margin-top: 30px;">
                        <h4 style="text-align: center; color: #667eea; margin-bottom: 10px;">📊 La Bàn Phong Thủy - Quẻ ${q}</h4>
                        <p style="text-align: center; font-size: 12px; color: #666; margin-bottom: 15px;">
                        <strong>Vòng 1:</strong> 8 Hướng | <strong>Vòng 2:</strong> 24 Sao Phúc Đức (khởi an tại <strong>${startPos}</strong>) | 
                        <strong>Vòng 3:</strong> 24 Cung (Thiên Can-Địa Chi) | <strong>Vòng 4:</strong> Cát/Hung Tinh | <strong>Vòng 5:</strong> 8 Quẻ | 
                        <strong>Trung Tâm:</strong> ${q}
                        <br><span style="color: #00008B;">■ Thiên Can</span> | <span style="color: #333;">■ Địa Chi</span> | <span style="color: #8B0000;">■ Quẻ</span>
                        <br><span style="color: #2E7D32;">■ Cát Tinh/Sao</span> | <span style="color: #C62828;">■ Hung Tinh/Sao</span>
                        <br><span style="background: rgba(76, 175, 80, 0.2); padding: 2px 8px;">■ Vùng Cát</span> | <span style="background: rgba(244, 67, 54, 0.2); padding: 2px 8px;">■ Vùng Hung</span>
                        ${doorDeg !== null && doorDeg !== undefined ? `<br><strong style="color: ${doorIsGood ? '#00C853' : '#FF1744'};">→ Hướng cửa chính: ${doorDeg}° (${doorIsGood ? 'CÁT' : 'HUNG'})</strong>` : ''}
                        <br><strong style="color: #e74c3c;">🧭 Kim đỏ:</strong> Hướng đang đo (kích hoạt la bàn để đo hướng thực tế)
                    </p>
                    <div class="compass-svg-container" style="position: relative;">
                        <!-- MŨI TÊN CỐ ĐỊNH NGOÀI SVG -->
                        <div id="interactiveCompassNeedle" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            width: 4px;
                            height: 220px;
                            margin-left: -2px;
                            margin-top: -110px;
                            opacity: 0;
                            pointer-events: none;
                            transition: opacity 0.3s;
                            transform-origin: 2px 110px;
                        ">
                            <!-- Đuôi xám -->
                            <div style="
                                position: absolute;
                                width: 4px;
                                height: 60px;
                                background: #95a5a6;
                                left: 0;
                                top: 110px;
                                border-radius: 2px;
                            "></div>
                            <!-- Mũi đỏ -->
                            <div style="
                                position: absolute;
                                width: 4px;
                                height: 110px;
                                background: #e74c3c;
                                left: 0;
                                top: 0;
                                border-radius: 2px;
                            "></div>
                            <!-- Đầu mũi tên -->
                            <div style="
                                position: absolute;
                                width: 0;
                                height: 0;
                                border-left: 8px solid transparent;
                                border-right: 8px solid transparent;
                                border-bottom: 14px solid #e74c3c;
                                left: -6px;
                                top: -14px;
                            "></div>
                            <!-- Tâm -->
                            <div style="
                                position: absolute;
                                width: 12px;
                                height: 12px;
                                background: #333;
                                border-radius: 50%;
                                left: -4px;
                                top: 104px;
                                box-shadow: 0 0 0 2px white;
                            "></div>
                        </div>
                        
                        <!-- LABEL ĐỘ -->
                        <div id="compassDegreeLabel" style="
                            position: absolute;
                            top: 10%;
                            left: 50%;
                            transform: translateX(-50%);
                            opacity: 0;
                            transition: opacity 0.3s;
                            background: rgba(231, 76, 60, 0.9);
                            padding: 8px 16px;
                            border-radius: 8px;
                            color: white;
                            font-weight: bold;
                            font-size: 16px;
                            white-space: nowrap;
                            pointer-events: none;
                            z-index: 100;
                        " id="needleDegreeText">0° - Bắc</div>
                        
                        ${svg}
                    </div>
                    <div class="compass-controls-bottom">
                        <button class="compass-btn-control compass-btn-activate" id="activateCompassBtn">
                            🧭 Kích Hoạt La Bàn
                        </button>
                        <button class="compass-btn-control compass-btn-apply" id="applyDirectionBtn" disabled>
                            ✓ Áp Dụng Hướng Này
                        </button>
                    </div>
                    <div class="compass-error-msg hidden" id="compassErrorMsg"></div>
                </div>`;
                
                return legend;
            }
        function getDoorExplanation(q, doorDir) {
            const qd = DATA.quai[q];
            const isGood = qd.dirs.good.includes(doorDir);
            const idx = isGood ? qd.dirs.good.indexOf(doorDir) : qd.dirs.bad.indexOf(doorDir);
            
            if (isGood) {
                const starNames = ['Sinh Khí (tài vận)', 'Thiên Y (sức khỏe)', 'Diên Niên (hôn nhân)', 'Phục Vị (bình an)'];
                return `✅ <strong>HƯỚNG TỐT!</strong><br>Cửa chính hướng <span class="highlight">${doorDir}</span> là hướng <strong>${starNames[idx]}</strong><br>${STAR_DESC[idx]}<br><em style="color: #4CAF50;">Cửa này sẽ đón tài khí vào nhà, rất thuận lợi!</em>`;
            } else {
                const badNames = ['Tuyệt Mệnh', 'Ngũ Quỷ', 'Lục Sát', 'Họa Hại'];
                return `⚠️ <strong>HƯỚNG XẤU!</strong><br>Cửa chính hướng <span class="highlight">${doorDir}</span> là hướng <strong>${badNames[idx]}</strong><br>${BAD_DESC[idx]}<br><em style="color: #f44336;">Nên xem xét thay đổi hoặc cải thiện bằng vật phong thủy.</em>`;
            }
        }

        function renderSection(title, content) {
            const section = document.createElement('div');
            section.className = 'result-card';
            section.innerHTML = `<h2>${title}</h2>${content}`;
            return section;
        }

        function calculateFengShui() {
            const y = parseInt(document.getElementById('year').value);
            const g = document.getElementById('gender').value;
            const doorDir = document.getElementById('doorDir').value;
            const errorDiv = document.getElementById('error-message');
            
            if (isNaN(y) || y < 1900 || y > 2100) {
                errorDiv.textContent = 'Năm sinh phải là số hợp lệ từ 1900 đến 2100!';
                errorDiv.style.display = 'block';
                return;
            }
            if (!g || !['nam', 'nu'].includes(g)) {
                errorDiv.textContent = 'Vui lòng chọn giới tính!';
                errorDiv.style.display = 'block';
                return;
            }
            if (!doorDir || !['Bắc', 'Đông Bắc', 'Đông', 'Đông Nam', 'Nam', 'Tây Nam', 'Tây', 'Tây Bắc'].includes(doorDir)) {
                errorDiv.textContent = 'Vui lòng chọn hướng cửa chính!';
                errorDiv.style.display = 'block';
                return;
            }
            errorDiv.style.display = 'none';

            const m = calcMenh(y);
            let mt = 'Thổ';
            if (m.includes('Kim')) mt = 'Kim';
            else if (m.includes('Mộc')) mt = 'Mộc';
            else if (m.includes('Thủy')) mt = 'Thủy';
            else if (m.includes('Hỏa')) mt = 'Hỏa';
            
            const q = calcQuai(y, g);
            const qd = DATA.quai[q];
            const md = DATA.menh[mt];

            const fragment = document.createDocumentFragment();

            // Section Thông Tin Mệnh & Quái Số
            fragment.appendChild(renderSection('🌟 Thông Tin Mệnh & Quái Số', `
                <div class="info-box">
                    <strong>Mệnh của bạn:</strong> <span class="element-tag ${md.element}">${m}</span>
                    <br><strong>Quái số:</strong> ${q}
                    <br><strong>Nhóm Tứ Trạch:</strong> ${qd.group}
                </div>
                <div class="detail-box"><strong>📖 Giải thích:</strong><br>${qd.explain}</div>
            `));

            // Section Phong Thủy Cửa Chính
            fragment.appendChild(renderSection('🏠 Phong Thủy Cửa Chính Nhà Bạn', `
                <div class="info-box" style="border-left-color: #FF6B00;">
                    <strong>Hướng cửa chính:</strong> <span class="highlight" style="background: #FFE4D6; color: #FF6B00;">🚪 ${doorDir}</span>
                    <br><br>${getDoorExplanation(q, doorDir)}
                </div>
            `));

            // Section La Bàn với Lá Bát Quái
            let compassHtml = `
                <div class="compass-section">
                    <div style="width: 100%; max-width: 500px;">${drawCompass(q, doorDir, preciseDoorDegree)}</div>
                    <div class="direction-note">
                        🚪 = Vị trí cửa chính của bạn | Sinh Khí, Thiên Y, Diên Niên, Phục Vị = Hướng tốt (xanh) | Tuyệt Mệnh, Ngũ Quỷ, Lục Sát, Họa Hại = Hướng xấu (đỏ)<br>
                        Các quẻ (Khảm, Cấn, Chấn, Tốn, Ly, Khôn, Đoài, Càn) thể hiện năng lượng của từng hướng.
                    </div>
                    <h3>🌟 Tứ Cát Tinh (Hướng Tốt):</h3>`;
            for (let i = 0; i < 4; i++) {
                compassHtml += `<div class="info-box" style="background:#f1f8f4;border-left-color:#4CAF50">
                    <strong>⭐ ${STARS[i]} - Hướng <span class="highlight">${qd.dirs.good[i]}</span></strong><br>${STAR_DESC[i]}
                </div>`;
            }
            compassHtml += `<h3>💀 Tứ Hung Tinh (Hướng Xấu):</h3>`;
            for (let i = 0; i < 4; i++) {
                compassHtml += `<div class="info-box" style="background:#fff5f5;border-left-color:#f44336">
                    <strong>💀 ${BAD_STARS[i]} - Hướng <span class="highlight">${qd.dirs.bad[i]}</span></strong><br>${BAD_DESC[i]}
                </div>`;
            }
            compassHtml += `</div>`;
            fragment.appendChild(renderSection('🧭 La Bàn 8 Hướng & Lá Bát Quái', compassHtml));

            // Section Phòng Bếp
            fragment.appendChild(renderSection('🍳 Phong Thủy Phòng Bếp', `
                <div class="info-box"><strong>🎯 Hướng TỐT NHẤT:</strong> Đặt bếp ở hướng <span class="highlight">${qd.dirs.bad[1]}</span> (Ngũ Quỷ) hoặc <span class="highlight">${qd.dirs.bad[2]}</span> (Lục Sát) để ép hung khí</div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Cửa Phòng Bếp (Theo Lỗ Ban 52.2cm - Dương Trạch):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">52.2cm</span> - Phát lộc<br>
                    • <span class="highlight">78.3cm</span> - Tài vận<br>
                    • <span class="highlight">104.4cm</span> - Sinh khí (tốt nhất)<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">156.6cm</span> - Vượng<br>
                    • <span class="highlight">208.8cm</span> - Sinh khí<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">104.4cm × 208.8cm</span>
                    
                    <h4>📍 Vị trí đặt bếp:</h4>
                    <strong>Nguyên tắc:</strong> Bếp nên đặt ở hướng XẤU để "đốt cháy" hung khí<br>
                    <strong>Vị trí tốt nhất:</strong> Phòng bếp ở phía <span class="highlight">${qd.dirs.bad[1]}</span> hoặc <span class="highlight">${qd.dirs.bad[2]}</span> của nhà<br>
                    <strong>Có thể chấp nhận:</strong> Đặt ở phía <span class="highlight">${qd.dirs.bad[3]}</span> (Họa Hại)
                    
                    <h4>🔥 Hướng miệng bếp khi nấu:</h4>
                    <strong>Miệng bếp hướng:</strong> <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) khi nấu nướng<br>
                    <em class="direction-note">"Miệng bếp" là hướng mà bạn đứng nấu, nguồn lửa/nhiệt hướng vào</em><br>
                    
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt một lư hương nhỏ bằng gốm hoặc đồng ở góc <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) để thu hút tài lộc.<br>
                    - Đặt bình phong hoặc cây lưỡi hổ ở cửa bếp hướng <span class="highlight">${qd.dirs.bad[0]}</span> (Tuyệt Mệnh) để hóa giải năng lượng xấu.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
                    
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Bếp KHÔNG được đối diện cửa chính</li>
                        <li>Tránh đặt bếp dưới nhà vệ sinh tầng trên</li>
                        <li>Không để bếp đối thẳng phòng ngủ</li>
                        <li>Bếp không nên nằm giữa nhà</li>
                        <li>Luôn giữ bếp sạch sẽ, thoáng mát</li>
                    </ul>
                </div>
            `));

            // Section Phòng Tắm & WC
            fragment.appendChild(renderSection('🚿 Phong Thủy Phòng Tắm & WC', `
                <div class="info-box"><strong>🎯 Nguyên tắc:</strong> Đặt ở hướng XẤU để hóa giải hung khí</div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Cửa Phòng Tắm/WC (Theo Lỗ Ban 52.2cm - Dương Trạch):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">52.2cm</span> - Phát lộc<br>
                    • <span class="highlight">78.3cm</span> - Tài vận<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">156.6cm</span> - Vượng<br>
                    • <span class="highlight">208.8cm</span> - Sinh khí<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">78.3cm × 208.8cm</span>
                    
                    <h4>📍 Vị trí phù hợp:</h4>
                    <strong>Vị trí tốt nhất:</strong> Đặt toilet/nhà tắm ở phía <span class="highlight">${qd.dirs.bad[1]}</span> hoặc <span class="highlight">${qd.dirs.bad[2]}</span><br>
                    <strong>Có thể chấp nhận:</strong> Đặt ở phía <span class="highlight">${qd.dirs.bad[0]}</span> hoặc <span class="highlight">${qd.dirs.bad[3]}</span><br>
                    <strong>Nguyên tắc:</strong> Toilet đặt ở hướng xấu để "xả" hung khí ra ngoài
                    
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt một viên thạch anh đen hoặc obsidian ở góc <span class="highlight">${qd.dirs.bad[0]}</span> (Tuyệt Mệnh) gần bồn rửa để hút năng lượng tiêu cực.<br>
                    - Treo chuông gió kim loại ở cửa phòng tắm hướng <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) để cân bằng khí.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
                    
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>LUÔN đóng nắp bồn cầu và cửa toilet</li>
                        <li>Phải có cửa sổ hoặc hệ thống thông gió tốt</li>
                        <li>Giữ khô ráo, sạch sẽ thường xuyên</li>
                        <li>Tuyệt đối KHÔNG để toilet ở trung tâm nhà</li>
                        <li>Không để toilet đối diện bếp hoặc bàn thờ</li>
                    </ul>
                </div>
            `));

            // Section Phòng Làm Việc
            fragment.appendChild(renderSection('📚 Phong Thủy Phòng Làm Việc', `
                <div class="info-box"><strong>🎯 Hướng TỐT NHẤT:</strong> <span class="highlight">${qd.dirs.good[0]} (Sinh Khí)</span> - tốt nhất cho công việc, tài vận</div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Cửa Phòng Làm Việc (Theo Lỗ Ban 52.2cm - Dương Trạch):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">78.3cm</span> - Tài vận<br>
                    • <span class="highlight">104.4cm</span> - Sinh khí (tốt nhất)<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">208.8cm</span> - Sinh khí<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">104.4cm × 208.8cm</span>
                    
                    <h4>📍 Vị trí phòng làm việc:</h4>
                    <strong>Tốt nhất:</strong> Phòng làm việc ở phía <span class="highlight">${qd.dirs.good[0]}</span> của nhà (Sinh Khí - vượng sự nghiệp)<br>
                    <strong>Lựa chọn 2:</strong> Đặt ở phía <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y - tốt nếu công việc áp lực)<br>
                    <strong>Lựa chọn 3:</strong> Đặt ở phía <span class="highlight">${qd.dirs.good[3]}</span> (Phục Vị - công việc ổn định)
                    
                    <h4>💼 Hướng ngồi làm việc:</h4>
                    <strong>Hướng ngồi tốt nhất:</strong> Ngồi hướng mặt về <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí)<br>
                    <strong>Hướng ngồi thay thế:</strong> Có thể ngồi hướng về <span class="highlight">${qd.dirs.good[1]}</span> hoặc <span class="highlight">${qd.dirs.good[2]}</span><br>
                    <em class="direction-note">"Hướng ngồi" là hướng bạn nhìn về khi ngồi làm việc</em>
                    
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt thạch anh vàng hoặc citrine trên bàn làm việc ở góc <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) để tăng tài vận.<br>
                    - Đặt tượng Phật hoặc cây kim ngân ở góc <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) để hỗ trợ sức khỏe tinh thần.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
                    
                    <h4>📏 Kích Thước Bàn Làm Việc (Theo Lỗ Ban 42.9cm):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">81.5cm</span> - Tài lộc<br>
                    • <span class="highlight">107.2cm</span> - Vượng khí (tốt nhất)<br>
                    <strong>Chiều sâu (MAY):</strong><br>
                    • <span class="highlight">42.9cm</span> - Phát tài<br>
                    • <span class="highlight">64.3cm</span> - Sinh khí<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">81.5cm</span> - Vượng<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">107.2cm × 64.3cm × 81.5cm</span>
                    
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Bàn làm việc PHẢI tựa lưng vào tường</li>
                        <li>KHÔNG ngồi quay lưng về phía cửa</li>
                        <li>Nên có ánh sáng tự nhiên từ bên trái</li>
                        <li>Tránh ngồi dưới dầm hoặc đèn treo</li>
                        <li>Bàn làm việc gọn gàng, có cây xanh</li>
                    </ul>
                </div>
            `));

            // Section Phòng Thờ & Bàn Thờ
            fragment.appendChild(renderSection('🙏 Phong Thủy Phòng Thờ & Bàn Thờ', `
                <div class="info-box"><strong>🎯 Hướng TỐT NHẤT:</strong> <span class="highlight">${qd.dirs.good[0]} (Sinh Khí)</span> hoặc <span class="highlight">${qd.dirs.good[1]} (Thiên Y)</span></div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Bàn Thờ (Theo Lỗ Ban 38.8cm - Âm Trạch):</h4>
                    <strong>Bàn thờ nhỏ:</strong><br>
                    • Chiều rộng: <span class="highlight">48cm</span> - Hỷ sự<br>
                    • Chiều sâu: <span class="highlight">48cm</span> - Hỷ sự<br>
                    • Chiều cao: <span class="highlight">108cm</span> - Tài vượng<br>
                    <strong>Bàn thờ trung bình (TỐT NHẤT):</strong><br>
                    • Chiều rộng: <span class="highlight">88cm</span> - Tiến bảo<br>
                    • Chiều sâu: <span class="highlight">61cm</span> - Tài vượng<br>
                    • Chiều cao: <span class="highlight">127cm</span> - Đại cát<br>
                    <strong>Bàn thờ lớn:</strong><br>
                    • Chiều rộng: <span class="highlight">107cm</span> - Tài vượng<br>
                    • Chiều sâu: <span class="highlight">69cm</span> - Thêm phúc<br>
                    • Chiều cao: <span class="highlight">153cm</span> - Đại cát<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #FFE4D6; padding: 5px 10px; border-radius: 5px; font-weight: bold;">88cm × 61cm × 127cm</span>
                    
                    <h4>📍 Vị trí đặt bàn thờ:</h4>
                    <strong>Vị trí tốt nhất:</strong> Đặt bàn thờ ở phía <span class="highlight">${qd.dirs.good[0]}</span> của nhà (Sinh Khí - vượng phúc lộc)<br>
                    <strong>Vị trí tốt thứ 2:</strong> Đặt bàn thờ ở phía <span class="highlight">${qd.dirs.good[1]}</span> của nhà (Thiên Y - che chở sức khỏe)<br>
                    <strong>Vị trí thay thế:</strong> Có thể đặt ở phía <span class="highlight">${qd.dirs.good[3]}</span> (Phục Vị - bình an)<br>
                    <strong>⚠️ TUYỆT ĐỐI TRÁNH:</strong> Không đặt bàn thờ ở phía <span style="color:#f44336;font-weight:bold">${qd.dirs.bad[0]}</span> (Tuyệt Mệnh) hoặc <span style="color:#f44336;font-weight:bold">${qd.dirs.bad[1]}</span> (Ngũ Quỷ)
                    
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt bát hương hoặc tượng Phật ở góc <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) trên bàn thờ để tăng phúc lộc.<br>
                    - Đặt đèn dầu hoặc nến nhỏ ở góc <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) để cầu sức khỏe cho gia đình.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
                    
                    <h4>🧭 Hướng bàn thờ (hướng mặt tượng/ảnh):</h4>
                    <strong>Hướng tốt nhất:</strong> Tượng/ảnh trên bàn thờ nên hướng mặt về <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí)<br>
                    <strong>Hướng tốt thứ 2:</strong> Có thể hướng về <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y)<br>
                    <strong>Hướng thay thế:</strong> Hướng về <span class="highlight">${qd.dirs.good[2]}</span> (Diên Niên) hoặc <span class="highlight">${qd.dirs.good[3]}</span> (Phục Vị)<br>
                    <em class="direction-note">Lưu ý: "Hướng bàn thờ" là hướng mặt của tượng/ảnh trên bàn thờ nhìn ra</em>
                    
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Bàn thờ PHẢI đặt ở vị trí cao nhất trong nhà</li>
                        <li>KHÔNG đặt dưới nhà vệ sinh/phòng ngủ tầng trên</li>
                        <li>KHÔNG để bàn thờ quay về phía toilet</li>
                        <li>Phía sau bàn thờ nên là tường vững chắc</li>
                        <li>KHÔNG đặt bàn thờ sát cửa ra vào</li>
                        <li>Tránh để bàn thờ dưới gầm cầu thang</li>
                        <li>Luôn giữ bàn thờ sạch sẽ, trang nghiêm</li>
                    </ul>
                </div>
            `));

            // Section Cầu Thang
            fragment.appendChild(renderSection('🪜 Phong Thủy Cầu Thang', `
                <div class="info-box"><strong>🎯 Nguyên tắc:</strong> Cầu thang nên đặt ở vị trí hướng <span class="highlight">${qd.dirs.bad[0]}</span> (Tuyệt Mệnh) hoặc <span class="highlight">${qd.dirs.bad[1]}</span> (Ngũ Quỷ)</div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Cầu Thang (Theo Lỗ Ban 42.9cm):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">85.8cm</span> - Tài lộc<br>
                    • <span class="highlight">107.2cm</span> - Vượng khí (tốt nhất)<br>
                    <strong>Chiều cao bậc (MAY):</strong><br>
                    • <span class="highlight">17.2cm</span> - Tài vượng<br>
                    • <span class="highlight">21.5cm</span> - Đại cát<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">107.2cm × 21.5cm (bậc)</span>
            
                    <h4>🔢 Số Bậc Cầu Thang (Theo Phong Thủy):</h4>
                    <strong>Nguyên tắc:</strong> Số bậc nên rơi vào cung <strong>Sinh</strong> hoặc <strong>Lão</strong> trong chu kỳ Sinh - Lão - Bệnh - Tử<br>
                    <strong>Số bậc tốt nhất:</strong><br>
                    • <span class="highlight">17 bậc</span> - Cung Sinh (tài lộc, sức sống)<br>
                    • <span class="highlight">21 bậc</span> - Cung Sinh (rất tốt, vượng khí)<br>
                    • <span class="highlight">22 bậc</span> - Cung Lão (ổn định, bền vững)<br>
                    • <span class="highlight">25 bậc</span> - Cung Sinh (tài lộc dồi dào)<br>
                    • - Bậc đầu tiên mà chân bạn bước lên, nâng cao hơn mặt sàn tầng.<br>
                    • - Bậc cuối cùng Đây là bậc cao nhất của cầu thang. Khi bạn đứng trên bậc này, bước tiếp theo bạn sẽ bước ra mặt sàn tầng trên. <br>
                    • - Lưu ý: Mặt sàn của tầng: KHÔNG được tính là một bậc cầu thang <br>
                    <strong>Số bậc cần tránh:</strong><br>
                    • <span class="highlight" style="background: #fff5f5; color: #f44336;">19 bậc</span> - Cung Bệnh (sức khỏe kém)<br>
                    • <span class="highlight" style="background: #fff5f5; color: #f44336;">20 bậc</span> - Cung Tử (năng lượng xấu)<br>
                    <em class="direction-note">Lưu ý: Tổng số bậc nên là số lẻ (17, 21, 25) để mang tính dương, tốt cho phong thủy.</em>
            
                    <h4>📍 Vị trí đặt cầu thang:</h4>
                    <strong>Tốt nhất:</strong> Cầu thang nên ở hướng <span class="highlight">${qd.dirs.bad[0]}</span> hoặc <span class="highlight">${qd.dirs.bad[1]}</span> để "dẫn" hung khí đi<br>
                    <strong>Có thể chấp nhận:</strong> Đặt ở góc của nhà, không ở giữa<br>
                    <strong>Tránh:</strong> KHÔNG đặt cầu thang ở hướng <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) - sẽ rò rỉ tài lộc
            
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt một đôi kỳ lân hoặc tượng rồng ở chân cầu thang hướng <span class="highlight">${qd.dirs.bad[0]}</span> (Tuyệt Mệnh) để trấn áp hung khí.<br>
                    - Treo gương bát quái nhỏ ở đầu cầu thang hướng <span class="highlight">${qd.dirs.good[3]}</span> (Phục Vị) để bảo vệ năng lượng tích cực.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
            
                    <h4>🔄 Hình dáng & kiểu cầu thang:</h4>
                    <strong>Tốt nhất:</strong> Cầu thang hình xoắn ốc hoặc hình chữ L<br>
                    <strong>Có thể chấp nhận:</strong> Cầu thang thẳng (nếu không ở giữa nhà)<br>
                    <strong>Tránh:</strong> <br>
                    • Cầu thang lệch lạc, bậc cao thấp không đều<br>
                    • Cầu thang quá dốc hoặc quá nông<br>
                    • Cầu thang đối diện trực tiếp với cửa chính<br>
                    • Cầu thang ở dưới dầm hoặc trong góc tối
            
                    <h4>🎨 Màu sắc cầu thang:</h4>
                    <strong>Nên chọn:</strong> Màu sáng, ấm áp (trắng, kem, nâu nhạt, xám nhạt)<br>
                    <strong>Chất liệu:</strong> Gỗ tự nhiên, đá, xi măng - tránh kính trong suốt<br>
                    <strong>Tránh:</strong> Màu đen, đỏ quá đậm, hoặc kính trong suốt (khí rò rỉ)
            
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>KHÔNG đặt cầu thang ở giữa nhà (rất xấu)</li>
                        <li>KHÔNG đặt bàn thờ dưới gầm cầu thang</li>
                        <li>Cầu thang đối diện cửa chính = tài lộc rò rỉ</li>
                        <li>Luôn giữ cầu thang sạch sẽ, không bụi bặm</li>
                        <li>Số bậc cầu thang nên là số lẻ và rơi vào cung Sinh hoặc Lão</li>
                    </ul>
                </div>
            `));

            // Section Phòng Khách
            fragment.appendChild(renderSection('🛋️ Phong Thủy Phòng Khách', `
                <div class="info-box"><strong>🎯 Hướng TỐT NHẤT:</strong> <span class="highlight">${qd.dirs.good[0]} (Sinh Khí)</span> - thu hút tài lộc và quý nhân</div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Cửa Phòng Khách (Theo Lỗ Ban 52.2cm - Dương Trạch):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">78.3cm</span> - Tài vận<br>
                    • <span class="highlight">104.4cm</span> - Sinh khí (tốt nhất)<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">208.8cm</span> - Sinh khí<br>
                    • <span class="highlight">234.9cm</span> - Phát lộc<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">104.4cm × 208.8cm</span>
                    
                    <h4>📍 Vị trí phòng khách:</h4>
                    <strong>Tốt nhất:</strong> Phòng khách ở phía <span class="highlight">${qd.dirs.good[0]}</span> của nhà (Sinh Khí - vượng tài vận, quý nhân)<br>
                    <strong>Lựa chọn 2:</strong> Đặt ở phía <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y - thoáng đãng, sáng sủa)<br>
                    <strong>Lựa chọn 3:</strong> Đặt ở phía <span class="highlight">${qd.dirs.good[3]}</span> (Phục Vị - bình an, ổn định)
                    
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt bể cá nhỏ hoặc thạch anh vàng ở góc <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) để thu hút tài lộc.<br>
                    - Đặt tượng phật Di Lặc hoặc cây phát tài ở góc <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) để mang lại sức khỏe và niềm vui.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
                    
                    <h4>🛋️ Hướng bàn ghế phòng khách:</h4>
                    <strong>Vị trí ghế chủ:</strong> Nên hướng mặt về <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) hoặc <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y)<br>
                    <strong>Nguyên tắc:</strong> Người ngồi nên có tường vững chắc ở phía sau lưng, tránh ngồi quay lưng về cửa<br>
                    
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Phòng khách phải rộng rãi, sáng sủa</li>
                        <li>KHÔNG để gương soi đối diện cửa chính</li>
                        <li>Luôn giữ phòng khách sạch sẽ, gọn gàng</li>
                    </ul>
                </div>
            `));

            // Section Phòng Ngủ
            fragment.appendChild(renderSection('🛏️ Phong Thủy Phòng Ngủ', `
                <div class="info-box"><strong>🎯 Hướng TỐT NHẤT:</strong> <span class="highlight">${qd.dirs.good[0]} (Sinh Khí)</span> hoặc <span class="highlight">${qd.dirs.good[1]} (Thiên Y)</span></div>
                <div class="detail-box">
                    <h4>📏 Kích Thước Cửa Phòng Ngủ (Theo Lỗ Ban 52.2cm - Dương Trạch):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">78.3cm</span> - Tài vận<br>
                    • <span class="highlight">104.4cm</span> - Sinh khí (tốt nhất)<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">208.8cm</span> - Sinh khí<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">104.4cm × 208.8cm</span>
                    
                    <h4>📏 Kích Thước Giường Ngủ (Theo Lỗ Ban 42.9cm):</h4>
                    <strong>Chiều rộng (MAY):</strong><br>
                    • <span class="highlight">128.7cm</span> - Tài lộc<br>
                    • <span class="highlight">171.6cm</span> - Vượng khí (tốt nhất)<br>
                    <strong>Chiều dài (MAY):</strong><br>
                    • <span class="highlight">193cm</span> - Đại cát<br>
                    <strong>Chiều cao (MAY):</strong><br>
                    • <span class="highlight">85.8cm</span> - Tài vượng<br>
                    <strong>✨ Kích thước TỐT NHẤT:</strong> <span style="background: #e8f5e9; padding: 5px 10px; border-radius: 5px; font-weight: bold;">171.6cm × 193cm × 85.8cm</span>
                    
                    <h4>📍 Vị trí đặt phòng ngủ:</h4>
                    <strong>Hướng ưu tiên 1:</strong> Phòng ngủ đặt ở phía <span class="highlight">${qd.dirs.good[0]}</span> của nhà (Sinh Khí - tốt cho tài lộc, con cái)<br>
                    <strong>Hướng ưu tiên 2:</strong> Phòng ngủ đặt ở phía <span class="highlight">${qd.dirs.good[1]}</span> của nhà (Thiên Y - tốt cho sức khỏe)<br>
                    <strong>Hướng thay thế:</strong> Có thể chọn <span class="highlight">${qd.dirs.good[2]}</span> (Diên Niên - tốt cho vợ chồng)
                    
                    <h4>🪴 Vật phẩm phong thủy:</h4>
                    <strong>Đề xuất:</strong> 
                    - Đặt thạch anh hồng hoặc tinh thể thạch anh tím ở góc <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) gần đầu giường để tăng sức khỏe.<br>
                    - Đặt đôi chim uyên ương hoặc tượng tình yêu ở góc <span class="highlight">${qd.dirs.good[2]}</span> (Diên Niên) để hòa thuận gia đạo.<br>
                    <em class="direction-note">Chọn vật phẩm theo mệnh ${m} (màu sắc: ${md.colors}) để tăng hiệu quả.</em>
                    
                    <h4>🛌 Hướng đầu giường nằm:</h4>
                    <strong>Tốt nhất:</strong> Đầu giường hướng về <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí)<br>
                    <strong>Lựa chọn 2:</strong> Đầu giường hướng về <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y)<br>
                    <strong>Lựa chọn 3:</strong> Đầu giường hướng về <span class="highlight">${qd.dirs.good[2]}</span> (Diên Niên)<br>
                    <em class="direction-note">Lưu ý: "Hướng đầu giường" là hướng đỉnh đầu bạn hướng về khi nằm trên giường</em>
                    
                    <h4>⚠️ Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Không đặt gương soi trực diện giường</li>
                        <li>Tránh dầm đè trực tiếp lên đầu giường</li>
                        <li>Giường không nên chung tường với toilet</li>
                        <li>Đầu giường nên tựa vào tường vững chắc</li>
                        <li>Tránh cửa phòng đối thẳng chân giường</li>
                    </ul>
                </div>
            `));

            // Section Vật Phẩm & Màu Sắc
            fragment.appendChild(renderSection('🎨 Vật Phẩm & Màu Sắc Phong Thủy', `
                <div class="detail-box">
                    <h4>🎨 Màu sắc tương sinh:</h4>
                    <strong>${md.colors}</strong><br><em class="direction-note">Dùng các màu này cho sơn tường, nội thất, quần áo</em>
                    
                    <h4>🏺 Vật phẩm nên đặt:</h4>
                    <strong>${md.items}</strong><br><em class="direction-note">Đặt ở hướng tốt (${qd.dirs.good[0]}, ${qd.dirs.good[1]}) để tăng vận</em>
                    
                    <h4>🌱 Cây phong thủy:</h4>
                    <strong>${md.plants}</strong><br><em class="direction-note">Đặt cây ở góc phòng khách hoặc hướng Sinh Khí</em>
                    
                    <h4>💎 Đá phong thủy & Vị trí đặt:</h4>
                    <strong>${md.stones}</strong><br>
                    <strong>📍 Vị trí đặt đá thạch anh trong nhà (theo quẻ ${q} và tuổi ${y}):</strong><br>
                    <ul style="margin-left: 20px;">
                        <li><strong>Tài lộc:</strong> Đặt cụm thạch anh vàng hoặc citrine ở <span class="highlight">${qd.dirs.good[0]}</span> (Sinh Khí) của phòng khách hoặc bàn làm việc để thu hút tài vận. Nếu có thể, đặt thêm ở góc trái cửa chính (nhìn từ trong ra).</li>
                        <li><strong>Sức khỏe:</strong> Đặt thạch anh hồng hoặc thạch anh tím ở <span class="highlight">${qd.dirs.good[1]}</span> (Thiên Y) gần đầu giường phòng ngủ hoặc góc phòng tắm để tăng cường năng lượng chữa lành.</li>
                        <li><strong>Hôn nhân & Gia đạo:</strong> Đặt thạch anh tím hoặc thạch anh trắng ở <span class="highlight">${qd.dirs.good[2]}</span> (Diên Niên) trong phòng khách hoặc khu vực sinh hoạt chung để thúc đẩy hòa thuận.</li>
                        <li><strong>Bình an & Ổn định:</strong> Đặt thạch anh đen hoặc obsidian ở <span class="highlight">${qd.dirs.good[3]}</span> (Phục Vị) gần cửa sổ hoặc góc học tập/làm việc để bảo vệ năng lượng tích cực.</li>
                    </ul>
                    <em style="color: #f44336;">⚠️ Lưu ý: Không đặt thạch anh tại hướng ${qd.dirs.bad[0]} (Tuyệt Mệnh)</em>
                </div>
            `));

            // Section Mẹo Tăng Cường Vận May
            fragment.appendChild(renderSection('💡 Mẹo Tăng Cường Vận May', `
                <div class="detail-box">
                    <ul style="margin-left: 20px;">
                        <li>✨ Thắp đèn ở hướng <strong>Sinh Khí</strong> (${qd.dirs.good[0]}) để tăng tài vận</li>
                        <li>🛏️ Đặt giường ở hướng <strong>Thiên Y</strong> (${qd.dirs.good[1]}) nếu ốm yếu</li>
                        <li>💑 Hướng <strong>Diên Niên</strong> (${qd.dirs.good[2]}) tốt cho vợ chồng hòa thuận</li>
                        <li>🌿 Đặt cây xanh, bể cá ở hướng tốt</li>
                        <li>🧹 Luôn giữ nhà cửa sạch sẽ, thoáng đãng</li>
                        <li>🗑️ Vứt bỏ đồ cũ, hư hỏng thường xuyên</li>
                        <li>🚪 Cửa chính đặt ở hướng <span class="highlight">${qd.dirs.good[0]}</span> hoặc <span class="highlight">${qd.dirs.good[1]}</span> để đón khí tốt</li>
                    </ul>
                </div>
            `));

            const results = document.getElementById('results');
            results.innerHTML = '';
            results.appendChild(fragment);
            results.classList.add('show');
            results.scrollIntoView({behavior: 'smooth'});
        }
        // ========== XỬ LÝ LA BÀN ĐIỆN TỬ TƯƠNG TÁC ==========
        let currentCompassHeading = 0;
        let isCompassActive = false;
        let detectedDirection = '';
        let deviceOrientationHandler = null;
        
        function getDirectionFromDegree(degree) {
            const directions = [
                { name: 'Bắc', min: 337.5, max: 22.5 },
                { name: 'Đông Bắc', min: 22.5, max: 67.5 },
                { name: 'Đông', min: 67.5, max: 112.5 },
                { name: 'Đông Nam', min: 112.5, max: 157.5 },
                { name: 'Nam', min: 157.5, max: 202.5 },
                { name: 'Tây Nam', min: 202.5, max: 247.5 },
                { name: 'Tây', min: 247.5, max: 292.5 },
                { name: 'Tây Bắc', min: 292.5, max: 337.5 }
            ];
            
            for (let dir of directions) {
                if (degree >= dir.min && degree < dir.max) {
                    return dir.name;
                }
            }
            return 'Bắc';
        }
        
        function handleDeviceOrientation(event) {
            let heading = null;
            
            if (event.webkitCompassHeading !== undefined) {
                heading = event.webkitCompassHeading;
            } else if (event.alpha !== null) {
                heading = 360 - event.alpha;
            }
            
            if (heading !== null && isCompassActive) {
                currentCompassHeading = Math.round(heading);
                detectedDirection = getDirectionFromDegree(currentCompassHeading);
                
                const compassSVG = document.getElementById('interactiveCompassSVG');
                const needle = document.getElementById('interactiveCompassNeedle');
                const degreeLabel = document.getElementById('compassDegreeLabel');
                const degreeText = document.getElementById('needleDegreeText');
                const applyBtn = document.getElementById('applyDirectionBtn');
                
                // Cập nhật text
                if (degreeText) degreeText.textContent = currentCompassHeading + '° - ' + detectedDirection;
                if (applyBtn) applyBtn.disabled = false;
                
                // KIM CỐ ĐỊNH (luôn chỉ lên = đầu điện thoại)
                if (needle) {
                    needle.style.transform = 'none';
                }
                
                // SVG XOAY NGƯỢC để hướng Bắc thực tế nằm đúng vị trí
                if (compassSVG) {
                    compassSVG.style.transformOrigin = 'center';
                    compassSVG.style.transform = `rotate(${-currentCompassHeading}deg)`;
                }
                
                // Label không xoay
                if (degreeLabel) {
                    degreeLabel.style.transform = 'none';
                }
            }
        }
        
        function stopCompass() {
            if (deviceOrientationHandler) {
                window.removeEventListener('deviceorientation', handleDeviceOrientation);
                deviceOrientationHandler = null;
            }
            
            isCompassActive = false;
            
            // Ẩn kim la bàn và label
            const needle = document.getElementById('interactiveCompassNeedle');
            const degreeLabel = document.getElementById('compassDegreeLabel');
            if (needle) needle.classList.remove('active');
            if (degreeLabel) degreeLabel.classList.remove('active');
            
            // Reset nút
            const activateBtn = document.getElementById('activateCompassBtn');
            if (activateBtn) {
                activateBtn.textContent = '🧭 Kích Hoạt La Bàn';
                activateBtn.classList.remove('active');
                activateBtn.disabled = false;
            }
        }
        
        async function activateInteractiveCompass() {
            const errorMsg = document.getElementById('compassErrorMsg');
            const activateBtn = document.getElementById('activateCompassBtn');
            const needle = document.getElementById('interactiveCompassNeedle');
            const degreeLabel = document.getElementById('compassDegreeLabel');
            
            if (errorMsg) errorMsg.classList.add('hidden');
            
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    
                    if (permission === 'granted') {
                        deviceOrientationHandler = handleDeviceOrientation;
                        window.addEventListener('deviceorientation', deviceOrientationHandler);
                        
                        activateBtn.textContent = '⏸ Đang Đo...';
                        activateBtn.classList.add('active');
                        activateBtn.disabled = true;
                        isCompassActive = true;
                        
                        // Hiện kim la bàn và label
                        if (needle) needle.classList.add('active');
                        if (degreeLabel) degreeLabel.classList.add('active');
                    } else {
                        throw new Error('Cần cấp quyền truy cập cảm biến để sử dụng la bàn');
                    }
                } else if (window.DeviceOrientationEvent) {
                    deviceOrientationHandler = handleDeviceOrientation;
                    window.addEventListener('deviceorientation', deviceOrientationHandler);
                    
                    activateBtn.textContent = '⏸ Đang Đo...';
                    activateBtn.classList.add('active');
                    activateBtn.disabled = true;
                    isCompassActive = true;
                    
                    // Hiện kim la bàn và label
                    if (needle) needle.classList.add('active');
                    if (degreeLabel) degreeLabel.classList.add('active');
                } else {
                    throw new Error('Thiết bị không hỗ trợ cảm biến la bàn');
                }
            } catch (error) {
                if (errorMsg) {
                    errorMsg.textContent = '⚠️ ' + error.message;
                    errorMsg.classList.remove('hidden');
                }
            }
        }
        
        function applyCompassDirection() {
            if (detectedDirection && currentCompassHeading !== null) {
                const doorDirSelect = document.getElementById('doorDir');
                doorDirSelect.value = detectedDirection;
                
                // Lưu độ chính xác
                preciseDoorDegree = currentCompassHeading;
                
                // Dừng đo và ẩn kim
                stopCompass();
                
                // Tự động tính lại
                calculateFengShui();
                
                // Thông báo
                alert('✓ Đã áp dụng hướng: ' + detectedDirection + ' (' + currentCompassHeading + '°)\n\nKết quả phong thủy đã được cập nhật!');
            }
        }
        
        // Gán sự kiện sau khi tính toán phong thủy
        const originalCalculate = calculateFengShui;
        calculateFengShui = function() {
            originalCalculate();
            
            setTimeout(() => {
                const activateBtn = document.getElementById('activateCompassBtn');
                const applyBtn = document.getElementById('applyDirectionBtn');
                
                if (activateBtn) {
                    const newActivateBtn = activateBtn.cloneNode(true);
                    activateBtn.parentNode.replaceChild(newActivateBtn, activateBtn);
                    newActivateBtn.addEventListener('click', activateInteractiveCompass);
                    
                    if (!window.DeviceOrientationEvent) {
                        const errorMsg = document.getElementById('compassErrorMsg');
                        if (errorMsg) {
                            errorMsg.textContent = '⚠️ Trình duyệt không hỗ trợ cảm biến la bàn';
                            errorMsg.classList.remove('hidden');
                        }
                        newActivateBtn.disabled = true;
                    }
                }
                
                if (applyBtn) {
                    const newApplyBtn = applyBtn.cloneNode(true);
                    applyBtn.parentNode.replaceChild(newApplyBtn, applyBtn);
                    newApplyBtn.addEventListener('click', applyCompassDirection);
                }
            }, 100);
        };
        
        // Reset khi chọn hướng thủ công
        document.getElementById('doorDir').addEventListener('change', function() {
            preciseDoorDegree = null;
            stopCompass();
        });
            </script>
</body>
</html>
