<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Ngày Đẹp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.8);
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 12px 18px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .control-group:hover {
            transform: translateY(-2px);
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        select, input {
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            outline: none;
            cursor: pointer;
        }

        input[type="number"] {
            width: 80px;
            text-align: center;
        }

        .calendar-container {
            padding: 20px;
            overflow-x: auto;
        }

        .current-month {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 700;
            color: #444;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(50px, 1fr));
            gap: 6px;
            max-width: 100%;
            margin: 0 auto;
            min-width: 350px;
        }

        .calendar-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 2px;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            min-width: 50px;
        }

        .calendar-day {
            background: white;
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
            min-height: 90px; /* Tăng chiều cao để chứa thêm Thiên Can, Địa Chi */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            min-width: 50px;
        }

        .calendar-day:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .calendar-day.selected {
            border-color: #e74c3c;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .calendar-day.empty {
            background: transparent;
            box-shadow: none;
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
        }

        .solar-date {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 3px;
        }

        .lunar-date {
            font-size: 0.75rem;
            color: #e74c3c;
            font-weight: 600;
            background: rgba(231, 76, 60, 0.1);
            padding: 2px 6px;
            border-radius: 8px;
            line-height: 1.2;
            margin-bottom: 3px;
        }

        .lunar-date.leap {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            animation: pulse 2s infinite;
        }

        .can-chi {
            font-size: 0.7rem;
            color: #2ecc71;
            font-weight: 600;
            background: rgba(46, 204, 113, 0.1);
            padding: 2px 6px;
            border-radius: 8px;
            line-height: 1.2;
        }

        .good-day {
            font-size: 0.9rem;
            color: #f1c40f;
            margin-top: 3px;
        }

        .bad-day {
            font-size: 0.9rem;
            color: #000000;
            margin-top: 3px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .today {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e) !important;
            border-color: #e17055 !important;
            box-shadow: 0 8px 25px rgba(225, 112, 85, 0.3) !important;
        }

        .today .solar-date {
            color: #d63031;
        }

        .weekend {
            background: linear-gradient(135deg, #fab1a0, #e17055);
        }

        .weekend .solar-date {
            color: white;
        }

        .weekend .lunar-date, .weekend .can-chi {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .day-info-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .day-info-container h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .day-info-container .day-info {
            font-size: 1rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .day-info-container .hours-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .day-info-container .hours-table th,
        .day-info-container .hours-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9rem;
        }

        .day-info-container .hours-table th {
            background: #f4f4f4;
            font-weight: 600;
        }

        .day-info-container .hours-table .good-hour {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .day-info-container .hours-table .bad-hour {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .control-group {
                width: 100%;
                justify-content: center;
            }

            .calendar {
                gap: 4px;
                min-width: 320px;
            }

            .calendar-header {
                font-size: 0.8rem;
                padding: 8px 2px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 6px 2px;
                min-width: 45px;
            }

            .solar-date {
                font-size: 1.1rem;
            }

            .lunar-date, .can-chi {
                font-size: 0.7rem;
                padding: 2px 4px;
            }

            .good-day, .bad-day {
                font-size: 0.8rem;
            }

            .day-info-container {
                margin: 10px;
                padding: 15px;
            }

            .day-info-container h3 {
                font-size: 1.3rem;
            }

            .day-info-container .day-info {
                font-size: 0.9rem;
            }

            .day-info-container .hours-table th,
            .day-info-container .hours-table td {
                font-size: 0.8rem;
                padding: 6px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .calendar {
                gap: 3px;
                min-width: 300px;
            }

            .calendar-header {
                font-size: 0.7rem;
                padding: 6px 1px;
            }

            .calendar-day {
                min-height: 70px;
                padding: 4px 1px;
                min-width: 40px;
            }

            .solar-date {
                font-size: 1rem;
            }

            .lunar-date, .can-chi {
                font-size: 0.65rem;
                padding: 1px 3px;
            }

            .good-day, .bad-day {
                font-size: 0.7rem;
            }

            .day-info-container {
                margin: 5px;
                padding: 10px;
            }

            .day-info-container h3 {
                font-size: 1.2rem;
            }

            .day-info-container .day-info {
                font-size: 0.85rem;
            }

            .day-info-container .hours-table th,
            .day-info-container .hours-table td {
                font-size: 0.75rem;
                padding: 5px;
            }
        }

        .calendar-day {
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-day:nth-child(8) { animation-delay: 0.1s; }
        .calendar-day:nth-child(9) { animation-delay: 0.2s; }
        .calendar-day:nth-child(10) { animation-delay: 0.3s; }
        .calendar-day:nth-child(11) { animation-delay: 0.4s; }
        .calendar-day:nth-child(12) { animation-delay: 0.5s; }
        .calendar-day:nth-child(13) { animation-delay: 0.6s; }
        .calendar-day:nth-child(14) { animation-delay: 0.7s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌙 Xem Ngày Đẹp</h1>
            <p> ⭐ Ngày đẹp ★ Ngày xấu. Ấn vào ngày để xem diễn giải phía dưới lịch </p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>📅 Tháng:</label>
                <select id="month" onchange="renderCalendar()">
                    <option value="1">Tháng 1</option>
                    <option value="2">Tháng 2</option>
                    <option value="3">Tháng 3</option>
                    <option value="4">Tháng 4</option>
                    <option value="5">Tháng 5</option>
                    <option value="6">Tháng 6</option>
                    <option value="7">Tháng 7</option>
                    <option value="8">Tháng 8</option>
                    <option value="9">Tháng 9</option>
                    <option value="10">Tháng 10</option>
                    <option value="11">Tháng 11</option>
                    <option value="12">Tháng 12</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>🗓️ Năm:</label>
                <input type="number" id="year" value="" min="1900" max="2100" onchange="renderCalendar()">
            </div>
        </div>
            
        <div class="calendar-container">
            <div class="current-month" id="currentMonth"></div>
            <div class="calendar" id="calendar"></div>
            <div class="day-info-container" id="dayInfo">
                <h3>Chọn một ngày</h3>
                <p class="day-info">Vui lòng chọn một ngày trên lịch để xem thông tin ngày tốt/xấu và giờ tốt/xấu.</p>
            </div>
        </div>
    </div>

    <script>
        // Danh sách ngày tốt/xấu
        const goodBadDays = [
            { name: "Bảo Thương - Ngày tốt", days: [6, 12, 18, 24, 30], months: [1, 4, 7, 10], description: "Ngày đẹp, xuất hành thuận lợi, làm được việc như mong muốn, gặp người lớn vừa lòng." },
            { name: "Đường Phong - Ngày tốt", days: [1, 7, 13, 19, 25], months: [1, 4, 7, 10], description: "Ngày đẹp, xuất hành thuận lợi, gặp được quý nhân phù trợ và cầu tài được như ý." },
            { name: "Kim Dương - Ngày tốt", days: [3, 9, 15, 21, 27], months: [1, 4, 7, 10], description: "Xuất hành và lúc về đều tốt, gặp được nhiều thuận lợi, nhận được sự giúp đỡ từ người khác, gặp may mắn trong các cuộc tranh luận, cầu tài được như ý." },
            { name: "Thuần Dương - Ngày tốt", days: [4, 10, 16, 22, 28], months: [1, 4, 7, 10], description: "Xuất hành và lúc về đều tốt, gặp được nhiều thuận lợi, nhận được sự giúp đỡ từ người khác, gặp may mắn trong các cuộc tranh luận, cầu tài được như ý." },
            { name: "Đạo Tặc - Ngày xấu", days: [5, 11, 17, 23, 29], months: [1, 4, 7, 10], description: "Là ngày xấu, nếu xuất hành sẽ bị hại, dễ bị mất của." },
            { name: "Kim Thổ - Ngày xấu", days: [2, 8, 14, 20, 26], months: [1, 4, 7, 10], description: "Xuất hành dễ bị nhỡ chuyến tàu xe, trên đường đi dễ gặp bất lợi, bị mất của, khó cầu tài." },
            { name: "Thiên Tài - Ngày tốt", days: [4, 12, 20, 28], months: [2, 5, 8, 11], description: "Nên xuất hành, cầu tài được thắng lợi và được nhiều người giúp đỡ, công việc thuận lợi." },
            { name: "Thiên Dương - Ngày tốt", days: [6, 14, 22], months: [2, 5, 8, 11], description: "Xuất hành tốt, cầu tài được tài. Hỏi vợ được vợ. Mọi việc đều như ý muốn." },
            { name: "Thiên Thương - Ngày tốt", days: [8, 16, 24, 30], months: [2, 5, 8, 11], description: "Xuất hành để gặp cấp trên thì tuyệt vời, cầu tài thì được tài. Mọi việc đều thuận lợi." },
            { name: "Thiên Đường - Ngày tốt", days: [3, 11, 19, 27], months: [2, 5, 8, 11], description: "Xuất hành tốt, mọi việc được như ý và gặp được quý nhân phù trợ, nếu xuất hành buôn bán thì mua may và bán đắt." },
            { name: "Thiên Môn - Ngày tốt", days: [2, 10, 18, 26], months: [2, 5, 8, 11], description: "Xuất hành thuận lợi, cầu được ước thấy và mọi việc dễ thành công." },
            { name: "Thiên Đạo - Ngày xấu", days: [1, 9, 17, 25], months: [2, 5, 8, 11], description: "Nếu là xuất hành cầu tài thì nên tránh vì dù được thì cũng dễ bị tốn kém hoặc dễ bị yếu lý mà thua thiệt." },
            { name: "Thiên Tặc - Ngày xấu", days: [5, 13, 21, 29], months: [2, 5, 8, 11], description: "Không tốt để xuất hành, mọi chuyện gặp phải dễ rơi vào tình huống xấu, không thích hợp để xuất hành cầu tài." },
            { name: "Thiên Hầu - Ngày xấu", days: [7, 15, 23], months: [2, 5, 8, 11], description: "Nếu xuất hành thì dễ rơi vào tình trạng cãi nhau, thậm chí có thể xảy ra tai nạn đổ máu." },
            { name: "Bạch Hổ Đầu - Ngày tốt", days: [2, 10, 18, 26], months: [3, 6, 9, 12], description: "Xuất hành cầu tài hoặc đi bất cứ đâu đều rất thuận lợi." },
            { name: "Bạch Hổ Kiếp - Ngày tốt", days: [3, 11, 19, 27], months: [3, 6, 9, 12], description: "Xuất hành đi theo hướng Bắc hoặc Nam đều thuận lợi, có thể xuất hành cầu tài để được như ý." },
            { name: "Thanh Long Kiếp - Ngày tốt", days: [7, 15, 23], months: [3, 6, 9, 12], description: "Xuất hành đi 3 phương 4 hướng đều rất tốt, mọi sự đều suôn sẻ như ý." },
            { name: "Thanh Long Đầu - Ngày tốt", days: [6, 14, 22, 30], months: [3, 6, 9, 12], description: "Nếu xuất hành thì nên đi sớm để thuận lợi hơn, có thể đi cầu tài vì mọi việc dễ thành công." },
            { name: "Thanh Long Túc - Ngày xấu", days: [8, 16, 24], months: [3, 6, 9, 12], description: "Không nên đi xa, không nên xuất hành vì không may mắn, không nhận được tài lộc thậm chí dây dưa vào kiện tụng còn dễ bị đuối lý." },
            { name: "Chu Tước - Ngày xấu", days: [1, 9, 17, 25], months: [3, 6, 9, 12], description: "Xuất hành hay đi cầu tài đều xấu, dễ bị mất của hoặc bị đuối lý khi dính vào kiện cáo." },
            { name: "Bạch Hổ Túc - Ngày xấu", days: [4, 12, 20, 28], months: [3, 6, 9, 12], description: "Mọi chuyện đều rất xấu, không nên đi xa, không nên chọn làm ngày xuất hành." },
            { name: "Huyền Vũ - Ngày xấu", days: [5, 13, 21, 29], months: [3, 6, 9, 12], description: "Nếu xuất hành ngày này thường dễ cãi nhau, không nên đi đâu, dễ gặp chuyện xấu." }
        ];

        // Danh sách Thiên Can và Địa Chi
        const thienCan = ['Giáp', 'Ất', 'Bính', 'Đinh', 'Mậu', 'Kỷ', 'Canh', 'Tân', 'Nhâm', 'Quý'];
        const diaChi = ['Tý', 'Sửu', 'Dần', 'Mão', 'Thìn', 'Tỵ', 'Ngọ', 'Mùi', 'Thân', 'Dậu', 'Tuất', 'Hợi'];

        // Hàm tính Thiên Can và Địa Chi
        // Hàm tính Thiên Can và Địa Chi
        function getCanChi(jd, type = 'day', year = null, month = null) {
            if (type === 'day') {
                // Tính Thiên Can của ngày
                const canIndex = (jd + 9) % 10;
                // Tính Địa Chi của ngày
                const chiIndex = (jd + 1) % 12;
                return `${thienCan[canIndex]} ${diaChi[chiIndex]}`;
            } else if (type === 'month' && year !== null && month !== null) {
                // Tính Thiên Can của năm
                const yearJd = jdFromDate(1, 1, year);
                const yearCanIndex = (yearJd + 9) % 10;
                // Tính Địa Chi của tháng (bắt đầu từ Dần cho tháng 1 âm lịch)
                const monthChiIndex = ((month - 1 + 2) % 12 + 12) % 12;
                // Tính Thiên Can của tháng
                const monthCanIndex = (2 * yearCanIndex + month + 3) % 10;
                return `${thienCan[monthCanIndex]} ${diaChi[monthChiIndex]}`;
            } else if (type === 'year' && year !== null) {
                // Tính Thiên Can và Địa Chi của năm
                const yearJd = jdFromDate(1, 1, year);
                const yearCanIndex = (year + 6) % 10;
                const yearChiIndex = (year + 8) % 12; // Địa Chi của năm, bắt đầu từ Tý cho năm 1984 (Giáp Tý)
                return `${thienCan[yearCanIndex]} ${diaChi[yearChiIndex]}`;
            }            
            return 'Không xác định';
        }

        // Hàm kiểm tra ngày tốt/xấu
        function checkGoodBadDay(lunarDay, lunarMonth, lunarLeap) {
            for (let item of goodBadDays) {
                if (item.months.includes(lunarMonth) && item.days.includes(lunarDay)) {
                    return {
                        name: item.name,
                        description: item.description,
                        isGood: item.name.includes("Ngày tốt")
                    };
                }
            }
            return null;
        }

        // Hàm tính số dư giờ tốt/xấu
        function calculateSoDu(ngay, thang, khac) {
            return (ngay + thang + khac - 2) % 6;
        }

        // Hàm xác định trạng thái và diễn giải giờ
        function getHourInfo(soDu) {
            let name = '';
            let explanation = '';
            let isGood = false;

            switch (soDu) {
                case 1:
                    name = 'Đại an';
                    explanation = 'Mọi việc đều tốt, cầu tài đi hướng Tây, Nam. Nhà cửa yên lành, người xuất hành đều bình yên.';
                    isGood = true;
                    break;
                case 2:
                    name = 'Tốc hỷ';
                    explanation = 'Vui sắp tới. Cầu tài đi hướng Nam, đi việc quan nhiều may mắn. Người xuất hành đều bình yên. Chăn nuôi đều thuận lợi, người đi có tin vui về.';
                    isGood = true;
                    break;
                case 3:
                    name = 'Lưu miền';
                    explanation = 'Nghiệp khó thành, cầu tài mờ mịt, kiện cáo nên hoãn lại. Người đi chưa có tin về. Đi hướng Nam tìm nhanh mới thấy, nên phòng ngừa cãi cọ, miệng tiếng rất tầm thường. Việc làm chậm, lâu la nhưng việc gì cũng chắc chắn.';
                    isGood = false;
                    break;
                case 4:
                    name = 'Xích khẩu';
                    explanation = 'Hay cãi cọ, gây chuyện đói kém, phải nên đề phòng, người đi nên hoãn lại, phòng người nguyền rủa, tránh lây bệnh.';
                    isGood = false;
                    break;
                case 5:
                    name = 'Tiểu cát';
                    explanation = 'Rất tốt lành, đi thường gặp may mắn. Buôn bán có lời, phụ nữ báo tin vui mừng, người đi sắp về nhà, mọi việc đều hòa hợp, có bệnh cầu tài sẽ khỏi, người nhà đều mạnh khỏe.';
                    isGood = true;
                    break;
                case 0:
                case 6:
                    name = 'Tuyệt hỷ';
                    explanation = 'Cầu tài không có lợi hay bị trái ý, ra đi gặp hạn, việc quan phải đòn, gặp ma quỷ cúng lễ mới an.';
                    isGood = false;
                    break;
            }
            return { name, explanation, isGood };
        }

        // Thuật toán của Hồ Ngọc Đức
        const TIME_ZONE = 7.0;

        function jdFromDate(dd, mm, yy) {
            let a = Math.floor((14 - mm) / 12);
            let y = yy + 4800 - a;
            let m = mm + 12 * a - 3;
            let jd = dd + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
            if (jd < 2299161) {
                jd = dd + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - 32083;
            }
            return jd;
        }

        function getNewMoonDay(k, timeZone = TIME_ZONE) {
            let T = k / 1236.85;
            let T2 = T * T;
            let T3 = T2 * T;
            let dr = Math.PI / 180;
            let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
            Jd1 = Jd1 + 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
            let M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
            let Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
            let F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
            let C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
            C1 = C1 - 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
            C1 = C1 - 0.0004 * Math.sin(dr * 3 * Mpr);
            C1 = C1 + 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
            C1 = C1 - 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
            C1 = C1 - 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
            C1 = C1 + 0.0010 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));
            let deltat;
            if (T < -11) {
                deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
            } else {
                deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
            }
            let JdNew = Jd1 + C1 - deltat;
            return Math.floor(JdNew + 0.5 + timeZone / 24);
        }

        function getSunLongitude(jdn, timeZone = TIME_ZONE) {
            let T = (jdn - 2451545.5 - timeZone / 24) / 36525;
            let T2 = T * T;
            let dr = Math.PI / 180;
            let M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
            let L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;
            let DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
            DL = DL + (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
            let L = L0 + DL;
            L = L * dr;
            L = L - Math.PI * 2 * Math.floor(L / (Math.PI * 2));
            return Math.floor(L / Math.PI * 6);
        }

        function getLunarMonth11(yy, timeZone = TIME_ZONE) {
            let off = jdFromDate(31, 12, yy) - 2415021;
            let k = Math.floor(off / 29.530588853);
            let nm = getNewMoonDay(k, timeZone);
            let sunLong = getSunLongitude(nm, timeZone);
            if (sunLong >= 9) {
                nm = getNewMoonDay(k - 1, timeZone);
            }
            return nm;
        }

        function getLeapMonthOffset(a11, timeZone = TIME_ZONE) {
            let k = Math.floor((a11 - 2415021.076998695) / 29.530588853 + 0.5);
            let last = 0;
            let i = 1;
            let arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
            do {
                last = arc;
                i++;
                arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
            } while (arc != last && i < 14);
            return i - 1;
        }

        function convertSolar2Lunar(dd, mm, yy, timeZone = TIME_ZONE) {
            let jd = jdFromDate(dd, mm, yy);
            let k = Math.floor((jd - 2415021.076998695) / 29.530588853);
            let monthStart = getNewMoonDay(k + 1, timeZone);
            if (monthStart > jd) {
                monthStart = getNewMoonDay(k, timeZone);
            }
            let a11 = getLunarMonth11(yy, timeZone);
            let b11 = a11;
            if (a11 >= monthStart) {
                yy--;
                a11 = getLunarMonth11(yy, timeZone);
            } else {
                b11 = getLunarMonth11(yy + 1, timeZone);
            }
            let lunarDay = jd - monthStart + 1;
            let diff = Math.floor((monthStart - a11) / 29);
            let lunarLeap = 0;
            let lunarMonth = diff + 11;
            if (b11 - a11 > 365) {
                let leapMonthDiff = getLeapMonthOffset(a11, timeZone);
                if (diff >= leapMonthDiff) {
                    lunarMonth = diff + 10;
                    if (diff == leapMonthDiff) {
                        lunarLeap = 1;
                    }
                }
            }
            if (lunarMonth > 12) {
                lunarMonth = lunarMonth - 12;
            }
            if (lunarMonth >= 11 && diff < 4) {
                yy--;
            }
            return { day: lunarDay, month: lunarMonth, year: yy, leap: lunarLeap, jd: jd };
        }

        // Hàm hiển thị thông tin ngày và giờ dưới lịch
        function showDayInfo(solarDate, lunarDate, title, dayDescription, lunarDay, lunarMonth, canChiDay, canChiMonth, canChiYear) {
            const dayInfoContainer = document.getElementById('dayInfo');
            
            dayInfoContainer.innerHTML = `
                <h3>${solarDate} (Âm lịch: ${lunarDate})</h3>
                <p class="day-info">Ngày: ${canChiDay}, Tháng: ${canChiMonth}, Năm: ${canChiYear}</p>
                <p class="day-info">${title ? `${title}: ${dayDescription}` : dayDescription}</p>
                <table class="hours-table">
                    <thead>
                        <tr>
                            <th>Giờ</th>
                            <th>Trạng thái</th>
                            <th>Diễn giải</th>
                        </tr>
                    </thead>
                    <tbody id="hoursTableBody"></tbody>
                </table>
            `;

            const hoursTableBody = document.getElementById('hoursTableBody');
            const hours = [
                { names: ['Tý', 'Ngọ'], times: ['23h00–01h00', '11h00–13h00'], khac: 1 },
                { names: ['Sửu', 'Mùi'], times: ['01h00–03h00', '13h00–15h00'], khac: 2 },
                { names: ['Dần', 'Thân'], times: ['03h00–05h00', '15h00–17h00'], khac: 3 },
                { names: ['Mão', 'Dậu'], times: ['05h00–07h00', '17h00–19h00'], khac: 4 },
                { names: ['Thìn', 'Tuất'], times: ['07h00–09h00', '19h00–21h00'], khac: 5 },
                { names: ['Tỵ', 'Hợi'], times: ['09h00–11h00', '21h00–23h00'], khac: 6 }
            ];

            hours.forEach(hour => {
                const soDu = calculateSoDu(lunarDay, lunarMonth, hour.khac);
                const hourInfo = getHourInfo(soDu);
                const row = document.createElement('tr');
                row.className = hourInfo.isGood ? 'good-hour' : 'bad-hour';
                row.innerHTML = `
                    <td>${hour.names[0]} (${hour.times[0]}), ${hour.names[1]} (${hour.times[1]})</td>
                    <td>${hourInfo.name}</td>
                    <td>${hourInfo.explanation}</td>
                `;
                hoursTableBody.appendChild(row);
            });
        }

        function renderCalendar() {
            const month = parseInt(document.getElementById('month').value);
            const year = parseInt(document.getElementById('year').value);
            const calendar = document.getElementById('calendar');
            const currentMonth = document.getElementById('currentMonth');
            
            calendar.innerHTML = '';
            
            // Update current month display
            const monthNames = [
                '', 'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
            ];
            const canChiYear = getCanChi(null, 'year', year);
            currentMonth.textContent = `${monthNames[month]} năm ${year} (${canChiYear})`;
        
            // Create calendar headers
            const daysOfWeek = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
            daysOfWeek.forEach(day => {
                const div = document.createElement('div');
                div.className = 'calendar-header';
                div.textContent = day;
                calendar.appendChild(div);
            });
        
            // Calculate calendar data
            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDay = new Date(year, month - 1, 1).getDay();
            const today = new Date();
            
            // Add empty cells for days before the first day
            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                calendar.appendChild(div);
            }
        
            // Add days of the month
            let selectedDayElement = null;
        
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                const dayOfWeek = new Date(year, month - 1, day).getDay();
                
                div.className = 'calendar-day';
                
                // Add weekend class
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    div.classList.add('weekend');
                }
                
                // Add today class
                if (year === today.getFullYear() && month === today.getMonth() + 1 && day === today.getDate()) {
                    div.classList.add('today');
                }
                
                const lunarResult = convertSolar2Lunar(day, month, year);
                const lunarText = lunarResult.leap ? 
                    `${lunarResult.day}/${lunarResult.month} Nhuận` : 
                    `${lunarResult.day}/${lunarResult.month}`;
                
                // Tính Thiên Can và Địa Chi
                const canChiDay = getCanChi(lunarResult.jd, 'day');
                const canChiMonth = getCanChi(null, 'month', lunarResult.year, lunarResult.month);
                
                // Kiểm tra ngày tốt/xấu
                const goodBadInfo = checkGoodBadDay(lunarResult.day, lunarResult.month, lunarResult.leap);
                let starHtml = '';
                let title = '';
                let description = 'Ngày này không có thông tin đặc biệt về tốt/xấu.';
                
                if (goodBadInfo) {
                    starHtml = goodBadInfo.isGood ? 
                        '<span class="good-day">⭐</span>' : 
                        '<span class="bad-day">★</span>';
                    title = goodBadInfo.name;
                    description = goodBadInfo.description;
                }
        
                div.innerHTML = `
                    <div class="solar-date">${day}</div>
                    <div class="lunar-date ${lunarResult.leap ? 'leap' : ''}">${lunarText}</div>
                    <div class="can-chi">${canChiDay}</div>
                    ${starHtml}
                `;
                
                // Thêm sự kiện nhấp chuột để hiển thị thông tin
                div.onclick = () => {
                    // Xóa lớp selected khỏi ngày đã chọn trước đó
                    if (selectedDayElement) {
                        selectedDayElement.classList.remove('selected');
                    }
                    // Thêm lớp selected cho ngày hiện tại
                    div.classList.add('selected');
                    selectedDayElement = div;
                    showDayInfo(
                        `${day}/${month}/${year}`, 
                        lunarText, 
                        title, 
                        description, 
                        lunarResult.day, 
                        lunarResult.month,
                        canChiDay,
                        canChiMonth,
                        canChiYear
                    );
                };
                
                // Add stagger animation delay
                div.style.animationDelay = `${(day - 1) * 0.02}s`;
                
                calendar.appendChild(div);
            }
        }

        // Initialize calendar with current date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            document.getElementById('month').value = currentMonth;
            document.getElementById('year').value = currentYear;
            
            renderCalendar();
        });

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            const monthSelect = document.getElementById('month');
            const yearInput = document.getElementById('year');
            
            if (e.key === 'ArrowLeft') {
                let month = parseInt(monthSelect.value);
                let year = parseInt(yearInput.value);
                
                if (month === 1) {
                    month = 12;
                    year--;
                } else {
                    month--;
                }
                
                monthSelect.value = month;
                yearInput.value = year;
                renderCalendar();
            } else if (e.key === 'ArrowRight') {
                let month = parseInt(monthSelect.value);
                let year = parseInt(yearInput.value);
                
                if (month === 12) {
                    month = 1;
                    year++;
                } else {
                    month++;
                }
                
                monthSelect.value = month;
                yearInput.value = year;
                renderCalendar();
            }
        });
    </script>
</body>
</html>
