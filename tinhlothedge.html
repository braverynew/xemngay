<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Hedge Calculator - EA Farm Rebate (Ch√≠nh x√°c 100%)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.8;
        }
        
        .content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e0e0e0;
        }
        
        .main-content {
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.1);
        }
        
        .helper-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 165, 0, 0.4);
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #FFA500;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 15px 10px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        tr:hover {
            background: #fff9e6;
        }
        
        .hedge-row {
            background: #fff3cd !important;
            font-weight: 600;
        }
        
        .hedge-row td {
            border-top: 2px solid #ffc107;
            border-bottom: 2px solid #ffc107;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
        }
        
        .metric-card .value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .metric-card .label {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .alert.info {
            background: #d1ecf1;
            border-left: 5px solid #0c5460;
            color: #0c5460;
        }
        
        .alert.warning {
            background: #fff3cd;
            border-left: 5px solid #856404;
            color: #856404;
        }
        
        .alert.success {
            background: #d4edda;
            border-left: 5px solid #155724;
            color: #155724;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .scenario-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
        }
        
        .scenario-card:hover {
            border-color: #FFA500;
            box-shadow: 0 4px 20px rgba(255, 165, 0, 0.2);
        }
        
        .scenario-card h4 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #FFA500;
            font-weight: 700;
        }
        
        .scenario-result {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .scenario-result:last-child {
            border-bottom: none;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #f0f0f0;
        }
        
        .profit-positive {
            color: #28a745;
            font-weight: 700;
        }
        
        .profit-negative {
            color: #dc3545;
            font-weight: 700;
        }
        
        .strategy-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .strategy-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid;
            transition: transform 0.3s;
        }
        
        .strategy-card:hover {
            transform: translateY(-5px);
        }
        
        .strategy-card.best {
            border-color: #28a745;
        }
        
        .strategy-card.good {
            border-color: #ffc107;
        }
        
        .strategy-card.bad {
            border-color: #dc3545;
        }
        
        .strategy-card h3 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .badge.best { background: #28a745; }
        .badge.good { background: #ffc107; color: #333; }
        .badge.bad { background: #dc3545; }
        
        .hedge-detail {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
            line-height: 1.8;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Smart Hedge Calculator - EA Farm Rebate</h1>
            <p>T·ª± ƒë·ªông t·ªëi ∆∞u h√≥a % Hedge - Copy config v√† d√°n v√†o EA c·ªßa b·∫°n!</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div class="alert info">
                    <strong>üí° T·ª± ƒë·ªông t·ªëi ∆∞u h√≥a:</strong><br>
                    ‚Ä¢ Calculator t·ª± ƒë·ªông t√≠nh % t·ªëi ∆∞u<br>
                    ‚Ä¢ M·ª•c ti√™u: T·ªïng hedge 80-85%<br>
                    ‚Ä¢ Gi√° ƒëi h∆∞·ªõng n√†o c≈©ng tho√°t ƒë∆∞·ª£c<br>
                    ‚Ä¢ Copy config v√† d√°n v√†o EA!
                </div>
                
                <div class="input-group">
                    <label>Lot ƒë·∫ßu ti√™n</label>
                    <input type="number" id="lotSize" value="0.1" step="0.01" min="0.01">
                </div>
                
                <div class="input-group">
                    <label>H·ªá s·ªë nh√¢n (Multiplier)</label>
                    <input type="number" id="multiplier" value="1.5" step="0.1" min="1.1">
                </div>
                
                <div class="input-group">
                    <label>S·ªë l·ªánh DCA t·ªëi ƒëa</label>
                    <input type="number" id="maxOrders" value="14" step="1" min="5" max="20">
                </div>
                
                <div class="input-group">
                    <label>Kho·∫£ng c√°ch DCA (points)</label>
                    <input type="number" id="dcaDistance" value="3000" step="100" min="500">
                    <div class="helper-text">XAUUSD: 1000 points = 1 ƒë∆°n v·ªã gi√°</div>
                </div>
                
                <div class="input-group">
                    <label>Spread trung b√¨nh (points)</label>
                    <input type="number" id="avgSpread" value="30" step="1" min="10">
                    <div class="helper-text">Spread XAUUSD: 20-40 points</div>
                </div>
                
                <div class="input-group">
                    <label>Ch·∫ø ƒë·ªô</label>
                    <select id="calculationMode">
                        <option value="auto">T·ª± ƒë·ªông (3 t·∫ßng t·ªëi ∆∞u)</option>
                        <option value="manual">Nh·∫≠p th·ªß c√¥ng</option>
                    </select>
                </div>
                
                <div id="manualInputs" style="display: none;">
                    <div class="input-group">
                        <label>Hedge Levels (VD: 10,13,14)</label>
                        <input type="text" id="hedgeLevels" value="10,13,14">
                    </div>
                    
                    <div class="input-group">
                        <label>Hedge Percents (VD: 100,100,50)</label>
                        <input type="text" id="hedgePercents" value="100,100,50">
                        <div class="helper-text">% c·ªßa T·ªîNG volume t√≠ch l≈©y</div>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculate()">
                    üîç T√çNH TO√ÅN
                </button>
            </div>
            
            <div class="main-content">
                <div id="results" style="display: none;">
                    <!-- Metrics -->
                    <div class="section-title">üìä T·ªïng quan</div>
                    <div class="analysis-grid" id="metricsGrid"></div>
                    
                    <!-- DCA Table -->
                    <div class="section-title" style="margin-top: 30px;">üìà Chi ti·∫øt c√°c l·ªánh DCA & Hedge</div>
                    <div class="table-container">
                        <table id="dcaTable"></table>
                    </div>
                    
                    <!-- Strategies -->
                    <div class="section-title">üí° So s√°nh chi·∫øn l∆∞·ª£c</div>
                    <div class="strategy-comparison" id="strategies"></div>
                    
                    <!-- Scenarios -->
                    <div class="section-title" style="margin-top: 30px;">üé≤ Ph√¢n t√≠ch k·ªãch b·∫£n (Strategy t·ªët nh·∫•t)</div>
                    <div class="scenario-grid" id="scenarios"></div>
                    
                    <!-- Warnings -->
                    <div id="warnings"></div>
                </div>
                
                <div id="placeholder" class="alert info" style="text-align: center; padding: 60px 20px;">
                    <h2 style="margin-bottom: 20px;">üëà Nh·∫≠p th√¥ng s·ªë b√™n tr√°i</h2>
                    <p style="font-size: 16px; line-height: 1.8;">
                        Calculator n√†y t√≠nh to√°n CH√çNH X√ÅC 100% theo logic EA<br>
                        Hedge % = % c·ªßa T·ªîNG volume t√≠ch l≈©y (kh√¥ng ph·∫£i volume th√™m v√†o)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('calculationMode').addEventListener('change', function() {
            const manual = document.getElementById('manualInputs');
            manual.style.display = this.value === 'manual' ? 'block' : 'none';
        });
        
        function calculate() {
            const lotSize = parseFloat(document.getElementById('lotSize').value);
            const multiplier = parseFloat(document.getElementById('multiplier').value);
            const maxOrders = parseInt(document.getElementById('maxOrders').value);
            const dcaDistance = parseFloat(document.getElementById('dcaDistance').value);
            const avgSpread = parseFloat(document.getElementById('avgSpread').value);
            const mode = document.getElementById('calculationMode').value;
            
            // Calculate DCA orders
            const orders = [];
            let cumulativeLot = 0;
            
            for (let i = 1; i <= maxOrders; i++) {
                const lot = lotSize * Math.pow(multiplier, i - 1);
                cumulativeLot += lot;
                
                // ‚úÖ Correct rebate formula: 0.4 √ó (spread/1000) √ó lot
                const rebate = 0.4 * (avgSpread / 1000) * lot;
                
                orders.push({
                    order: i,
                    lot: lot,
                    cumulative: cumulativeLot,
                    rebate: rebate
                });
            }
            
            const totalLot = cumulativeLot;
            const totalRebate = orders.reduce((sum, o) => sum + o.rebate, 0);
            
            // Generate strategies
            let strategies;
            if (mode === 'auto') {
                strategies = generateOptimalStrategies(orders, totalLot);
            } else {
                const levels = document.getElementById('hedgeLevels').value.split(',').map(x => parseInt(x.trim()));
                const percents = document.getElementById('hedgePercents').value.split(',').map(x => parseFloat(x.trim()));
                strategies = [createStrategy(orders, totalLot, 'Manual', levels, percents, 'T√πy ch·ªânh')];
            }
            
            // Display results
            displayMetrics(totalLot, maxOrders, totalRebate);
            displayTable(orders, strategies[0]);
            displayStrategies(strategies, orders, dcaDistance, totalRebate);
            displayScenarios(strategies[0], orders, dcaDistance, totalRebate);
            displayWarnings(strategies[0], totalLot);
            
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }
        
        function generateOptimalStrategies(orders, totalLot) {
            const strategies = [];
            const maxOrders = orders.length;
            
            // Strategy 1: 10-12-14 (GAP nh·ªè)
            if (maxOrders >= 14) {
                const percents1 = calculateOptimalPercents(orders, [10, 12, 14], 82);
                strategies.push(createStrategy(orders, totalLot, '10-12-14 (GAP nh·ªè)', 
                    [10, 12, 14],
                    percents1,
                    'GAP 2 l·ªánh - Hedge ~82%'
                ));
            }
            
            // Strategy 2: 10-13-14 (GAP l·ªõn - T·ªêI ∆ØU)
            if (maxOrders >= 14) {
                const percents2 = calculateOptimalPercents(orders, [10, 13, 14], 83);
                strategies.push(createStrategy(orders, totalLot, '10-13-14 (GAP l·ªõn)', 
                    [10, 13, 14],
                    percents2,
                    '‚≠ê GAP 3 l·ªánh (11-12 t·ª± do) - T·ªêI ∆ØU'
                ));
            }
            
            // Strategy 3: 11-13-14 (Mu·ªôn h∆°n)
            if (maxOrders >= 14) {
                const percents3 = calculateOptimalPercents(orders, [11, 13, 14], 82);
                strategies.push(createStrategy(orders, totalLot, '11-13-14 (Mu·ªôn)', 
                    [11, 13, 14],
                    percents3,
                    'L·ªánh 1-10 t·ª± do - Hedge ~82%'
                ));
            }
            
            // Strategy 4: 10-13 (Ch·ªâ 2 t·∫ßng)
            if (maxOrders >= 13) {
                const percents4 = calculateOptimalPercents(orders, [10, 13], 83);
                strategies.push(createStrategy(orders, totalLot, '10-13 (2 t·∫ßng)', 
                    [10, 13],
                    percents4,
                    'ƒê∆°n gi·∫£n - L·ªánh 14 t·ª± do - Hedge ~83%'
                ));
            }
            
            // Strategy 5: Manual balanced (for reference)
            if (maxOrders >= 14) {
                strategies.push(createStrategy(orders, totalLot, '9-11-13 (Tham kh·∫£o)', 
                    [9, 11, 13],
                    [100, 50, 30],
                    'Config th√¥ng th∆∞·ªùng (kh√¥ng t·ªëi ∆∞u)'
                ));
            }
            
            return strategies;
        }
        
        // ‚úÖ NEW: Calculate optimal hedge percentages to achieve target total hedge ratio
        function calculateOptimalPercents(orders, levels, targetHedgePercent) {
            const totalLot = orders[orders.length - 1].cumulative;
            const targetHedgeVolume = totalLot * targetHedgePercent / 100;
            
            const numLevels = levels.length;
            
            if (numLevels === 3) {
                // For 3 levels: Use pyramid pattern (decreasing %)
                // Level 1: 100%, Level 2: 50-80%, Level 3: 20-50%
                
                const vol1 = orders[levels[0] - 1].cumulative;
                const vol2 = orders[levels[1] - 1].cumulative;
                const vol3 = orders[levels[2] - 1].cumulative;
                
                // Try combinations to find best match
                let bestPercents = [100, 60, 30];
                let bestDiff = 999;
                
                for (let p2 = 80; p2 >= 40; p2 -= 5) {
                    for (let p3 = 50; p3 >= 20; p3 -= 5) {
                        // Total hedge = vol1√ó100% + vol2√óp2% + vol3√óp3%
                        let totalHedge = (vol1 * 100 / 100) + (vol2 * p2 / 100) + (vol3 * p3 / 100);
                        let ratio = totalHedge / totalLot * 100;
                        let diff = Math.abs(ratio - targetHedgePercent);
                        
                        if (diff < bestDiff) {
                            bestDiff = diff;
                            bestPercents = [100, p2, p3];
                        }
                    }
                }
                
                return bestPercents;
            }
            else if (numLevels === 2) {
                // For 2 levels: Level 1: 100%, Level 2: adjust to hit target
                const vol1 = orders[levels[0] - 1].cumulative;
                const vol2 = orders[levels[1] - 1].cumulative;
                
                // totalHedge = vol1√ó100% + vol2√óp2%
                // targetHedge = totalLot √ó targetPercent
                // Solve: vol1 + vol2√óp2/100 = totalLot √ó targetPercent / 100
                
                let p2 = ((targetHedgeVolume - vol1) / vol2) * 100;
                p2 = Math.round(p2);
                p2 = Math.max(40, Math.min(120, p2)); // Reasonable bounds
                
                return [100, p2];
            }
            
            // Default fallback
            return new Array(numLevels).fill(100);
        }
        
        function createStrategy(orders, totalLot, name, levels, percents, description) {
            const hedgeOrders = [];
            let totalHedgeVolume = 0;
            
            // ‚úÖ EA Logic: hedgeVolume = currentDCAVolume √ó hedgePercent / 100
            levels.forEach((level, idx) => {
                const orderAtLevel = orders[level - 1];
                const cumulativeAtLevel = orderAtLevel.cumulative;
                const hedgePercent = percents[idx];
                
                // Hedge volume = % of TOTAL cumulative volume at this level
                const hedgeVolume = cumulativeAtLevel * hedgePercent / 100;
                
                totalHedgeVolume += hedgeVolume;
                
                hedgeOrders.push({
                    level: level,
                    percent: hedgePercent,
                    cumulativeAtLevel: cumulativeAtLevel,
                    hedgeVolume: hedgeVolume,
                    totalHedgeSoFar: totalHedgeVolume
                });
            });
            
            const netLot = totalLot - totalHedgeVolume;
            const hedgePercent = (totalHedgeVolume / totalLot) * 100;
            
            return {
                name: name,
                description: description,
                levels: levels,
                percents: percents,
                hedgeOrders: hedgeOrders,
                totalHedge: totalHedgeVolume,
                netLot: netLot,
                hedgePercent: hedgePercent
            };
        }
        
        function displayMetrics(totalLot, maxOrders, totalRebate) {
            const html = `
                <div class="metric-card">
                    <div class="label">T·ªïng Volume DCA</div>
                    <div class="value">${totalLot.toFixed(2)}</div>
                    <div class="label">lot</div>
                </div>
                <div class="metric-card">
                    <div class="label">S·ªë l·ªánh</div>
                    <div class="value">${maxOrders}</div>
                    <div class="label">orders</div>
                </div>
                <div class="metric-card">
                    <div class="label">T·ªïng Rebate</div>
                    <div class="value">$${totalRebate.toFixed(2)}</div>
                    <div class="label">0.4√ó(spread/1000)√ólot</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = html;
        }
        
        function displayTable(orders, bestStrategy) {
            let html = `
                <thead>
                    <tr>
                        <th>L·ªánh</th>
                        <th>Lot/l·ªánh</th>
                        <th>T·ªïng Lot</th>
                        <th>% T·ªïng</th>
                        <th>Rebate</th>
                        <th>Hedge Level</th>
                        <th>Hedge %</th>
                        <th>Hedge Volume</th>
                        <th>T·ªïng Hedge</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let cumulativeRebate = 0;
            
            orders.forEach(order => {
                cumulativeRebate += order.rebate;
                const hedgeOrder = bestStrategy.hedgeOrders.find(h => h.level === order.order);
                const isHedgeRow = hedgeOrder !== undefined;
                const percent = (order.cumulative / orders[orders.length - 1].cumulative * 100).toFixed(1);
                
                html += `
                    <tr ${isHedgeRow ? 'class="hedge-row"' : ''}>
                        <td><strong>${order.order}</strong></td>
                        <td>${order.lot.toFixed(2)}</td>
                        <td><strong>${order.cumulative.toFixed(2)}</strong></td>
                        <td>${percent}%</td>
                        <td>$${order.rebate.toFixed(4)}</td>
                        <td>${isHedgeRow ? 'üéØ Level ' + order.order : '-'}</td>
                        <td>${isHedgeRow ? '<strong>' + hedgeOrder.percent + '%</strong>' : '-'}</td>
                        <td>${isHedgeRow ? '<strong>' + hedgeOrder.hedgeVolume.toFixed(2) + '</strong>' : '-'}</td>
                        <td>${isHedgeRow ? hedgeOrder.totalHedgeSoFar.toFixed(2) : '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            document.getElementById('dcaTable').innerHTML = html;
        }
        
        function displayStrategies(strategies, orders, dcaDistance, totalRebate) {
            let html = '';
            
            // Find best
            let bestStrategy = strategies[0];
            let bestScore = evaluateStrategy(strategies[0], orders, dcaDistance, totalRebate);
            
            strategies.forEach(strategy => {
                const score = evaluateStrategy(strategy, orders, dcaDistance, totalRebate);
                if (score > bestScore) {
                    bestScore = score;
                    bestStrategy = strategy;
                }
            });
            
            strategies.forEach(strategy => {
                const isBest = strategy === bestStrategy;
                const cardClass = isBest ? 'best' : (strategy.hedgePercent >= 75 && strategy.hedgePercent <= 90 ? 'good' : 'bad');
                const emoji = isBest ? 'üèÜ' : (strategy.hedgePercent >= 75 ? '‚öñÔ∏è' : '‚ö†Ô∏è');
                
                // Calculate GAP info
                let gapInfo = '';
                if (strategy.levels.length >= 2) {
                    const gaps = [];
                    for (let i = 1; i < strategy.levels.length; i++) {
                        const gap = strategy.levels[i] - strategy.levels[i-1];
                        if (gap > 1) {
                            const gapOrders = [];
                            let gapVolume = 0;
                            for (let j = strategy.levels[i-1] + 1; j < strategy.levels[i]; j++) {
                                gapOrders.push(j);
                                gapVolume += orders[j - 1].lot;
                            }
                            if (gapOrders.length > 0) {
                                gaps.push(`L${strategy.levels[i-1]}-${strategy.levels[i]}: L·ªánh ${gapOrders.join(',')} (${gapVolume.toFixed(2)} lot t·ª± do)`);
                            }
                        }
                    }
                    if (gaps.length > 0) {
                        gapInfo = `<div class="hedge-detail">
                            <strong>üìä L·ªánh t·ª± do trong GAP:</strong><br>
                            ${gaps.join('<br>')}
                        </div>`;
                    }
                }
                
                // Hedge details
                let hedgeDetails = '<div class="hedge-detail"><strong>üî∫ C√°c l·ªánh Hedge EA s·∫Ω m·ªü:</strong><br>';
                strategy.hedgeOrders.forEach(h => {
                    hedgeDetails += `‚Ä¢ Level ${h.level}: M·ªü ${h.hedgeVolume.toFixed(2)} lot (${h.percent}% c·ªßa ${h.cumulativeAtLevel.toFixed(2)} lot)<br>`;
                });
                hedgeDetails += '</div>';
                
                // Test scenarios
                const reversalProfit = testScenario(strategy, orders, dcaDistance * 0.5, totalRebate, true);
                const continueProfit = testScenario(strategy, orders, dcaDistance * 0.5, totalRebate, false);
                
                html += `
                    <div class="strategy-card ${cardClass}">
                        <h3>
                            ${emoji} ${strategy.name}
                            ${isBest ? '<span class="badge best">T·ªêI ∆ØU</span>' : ''}
                        </h3>
                        <p style="margin-bottom: 10px; color: #666; font-size: 13px;">${strategy.description}</p>
                        ${gapInfo}
                        ${hedgeDetails}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span>T·ªïng Hedge:</span>
                                <strong>${strategy.totalHedge.toFixed(2)} lot (${strategy.hedgePercent.toFixed(1)}%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span>NET t·ª± do:</span>
                                <strong style="color: #FFA500;">${strategy.netLot.toFixed(2)} lot (${(100 - strategy.hedgePercent).toFixed(1)}%)</strong>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #666;">TEST NHANH:</div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="font-size: 13px;">ƒê·∫£o chi·ªÅu ${(dcaDistance * 0.5).toFixed(0)} pts:</span>
                                <strong class="${reversalProfit > 0 ? 'profit-positive' : 'profit-negative'}">${reversalProfit > 0 ? '+' : ''}$${reversalProfit.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="font-size: 13px;">ƒêi ti·∫øp ${(dcaDistance * 0.5).toFixed(0)} pts:</span>
                                <strong class="${continueProfit > 0 ? 'profit-positive' : 'profit-negative'}">${continueProfit > 0 ? '+' : ''}$${continueProfit.toFixed(2)}</strong>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-size: 12px;">
                            <strong>üìã Config EA (ƒê√£ t·ªëi ∆∞u h√≥a):</strong><br>
                            HedgeLevels = "${strategy.levels.join(',')}"<br>
                            HedgePercents = "${strategy.percents.map(p => Math.round(p)).join(',')}"<br>
                            <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #90caf9; color: #0277bd; font-size: 11px;">
                                üí° % ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n t·ª± ƒë·ªông ƒë·ªÉ ƒë·∫°t t·ªïng hedge ${strategy.hedgePercent.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('strategies').innerHTML = html;
        }
        
        function evaluateStrategy(strategy, orders, dcaDistance, totalRebate) {
            let score = 0;
            
            // Prefer 3 layers
            if (strategy.levels.length === 3) score += 50;
            else if (strategy.levels.length === 2) score += 30;
            
            // Start from level 10+
            if (strategy.levels[0] >= 10) score += 40;
            else if (strategy.levels[0] >= 9) score += 20;
            
            // Prefer 80-85% hedge
            if (strategy.hedgePercent >= 80 && strategy.hedgePercent <= 85) score += 50;
            else if (strategy.hedgePercent >= 75 && strategy.hedgePercent < 90) score += 30;
            
            // Check GAP
            if (strategy.levels.length >= 2) {
                const gap1 = strategy.levels[1] - strategy.levels[0];
                if (gap1 >= 3) score += 60;
                else if (gap1 >= 2) score += 40;
            }
            
            // Test scenarios
            const reversalProfit = testScenario(strategy, orders, dcaDistance * 0.5, totalRebate, true);
            const continueProfit = testScenario(strategy, orders, dcaDistance * 0.5, totalRebate, false);
            
            if (reversalProfit > 3 && continueProfit > 0) score += 100;
            else if (reversalProfit > 0) score += 50;
            
            return score;
        }
        
        function testScenario(strategy, orders, movePoints, totalRebate, isReversal) {
            const totalDCA = orders[orders.length - 1].cumulative;
            const totalHedge = strategy.totalHedge;
            const netPosition = totalDCA - totalHedge;
            
            if (isReversal) {
                // Price reverses (favorable for DCA)
                const profit = netPosition * movePoints * 0.01;
                return profit + totalRebate;
            } else {
                // Price continues (favorable for hedge if hedge > DCA)
                const hedgeAdvantage = totalHedge - totalDCA;
                const profit = hedgeAdvantage * movePoints * 0.01;
                return profit + totalRebate;
            }
        }
        
        function displayScenarios(strategy, orders, dcaDistance, totalRebate) {
            const scenarios = [
                { name: 'ƒê·∫£o chi·ªÅu nh·∫π', move: dcaDistance * 0.3, reversal: true, emoji: 'üìà' },
                { name: 'ƒê·∫£o chi·ªÅu v·ª´a', move: dcaDistance * 0.5, reversal: true, emoji: 'üìä' },
                { name: 'ƒê·∫£o chi·ªÅu m·∫°nh', move: dcaDistance * 1.0, reversal: true, emoji: 'üöÄ' },
                { name: 'ƒêi ti·∫øp nh·∫π', move: dcaDistance * 0.3, reversal: false, emoji: '‚¨áÔ∏è' },
                { name: 'ƒêi ti·∫øp v·ª´a', move: dcaDistance * 0.5, reversal: false, emoji: 'üìâ' },
                { name: 'ƒêi ti·∫øp m·∫°nh', move: dcaDistance * 1.0, reversal: false, emoji: '‚ö°' }
            ];
            
            let html = '';
            
            scenarios.forEach(scenario => {
                const profit = testScenario(strategy, orders, scenario.move, totalRebate, scenario.reversal);
                const profitClass = profit > 0 ? 'profit-positive' : 'profit-negative';
                const exitStatus = profit > 3 ? '‚úÖ THO√ÅT ƒê∆Ø·ª¢C' : (profit > 0 ? '‚ö†Ô∏è L·ªùi √≠t' : '‚ùå Ch∆∞a ƒë·ªß');
                
                html += `
                    <div class="scenario-card">
                        <h4>${scenario.emoji} ${scenario.name}</h4>
                        <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                            ${scenario.reversal ? 'Gi√° ƒë·∫£o chi·ªÅu' : 'Gi√° ti·∫øp t·ª•c'}: ${scenario.move.toFixed(0)} points
                        </p>
                        <div class="scenario-result">
                            <span>NET position:</span>
                            <span>${strategy.netLot.toFixed(2)} lot</span>
                        </div>
                        <div class="scenario-result">
                            <span>Profit t·ª´ di chuy·ªÉn:</span>
                            <span class="${profitClass}">$${(profit - totalRebate).toFixed(2)}</span>
                        </div>
                        <div class="scenario-result">
                            <span>Rebate:</span>
                            <span class="profit-positive">+$${totalRebate.toFixed(2)}</span>
                        </div>
                        <div class="scenario-result">
                            <span><strong>Total Profit:</strong></span>
                            <span class="${profitClass}"><strong>$${profit.toFixed(2)}</strong></span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 2px solid #f0f0f0;">
                            <strong style="font-size: 15px;">${exitStatus}</strong>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('scenarios').innerHTML = html;
        }
        
        function displayWarnings(strategy, totalLot) {
            let html = '';
            
            if (strategy.levels[0] < 10) {
                html += `
                    <div class="alert warning">
                        <strong>‚ö†Ô∏è C·∫£nh b√°o: Hedge qu√° s·ªõm (Level ${strategy.levels[0]})</strong><br>
                        Hedge tr∆∞·ªõc level 10 s·∫Ω kh√≥a c√°c l·ªánh nh·ªè ‚Üí Kh√≥ tho√°t khi gi√° h·ªìi.<br>
                        <strong>Khuy·∫øn ngh·ªã:</strong> B·∫Øt ƒë·∫ßu t·ª´ level 10 tr·ªü ƒëi.
                    </div>
                `;
            }
            
            if (strategy.levels.length > 3) {
                html += `
                    <div class="alert warning">
                        <strong>‚ö†Ô∏è Qu√° nhi·ªÅu t·∫ßng (${strategy.levels.length})</strong><br>
                        Nhi·ªÅu t·∫ßng = ph·ª©c t·∫°p. N√™n d√πng 3 t·∫ßng th√¥i.
                    </div>
                `;
            }
            
            // Check GAP
            let hasGoodGap = false;
            for (let i = 1; i < strategy.levels.length; i++) {
                const gap = strategy.levels[i] - strategy.levels[i-1];
                if (gap >= 2) {
                    hasGoodGap = true;
                    break;
                }
            }
            
            if (!hasGoodGap && strategy.levels.length > 1) {
                html += `
                    <div class="alert warning">
                        <strong>‚ö†Ô∏è GAP qu√° nh·ªè!</strong><br>
                        C√°c level hedge qu√° g·∫ßn ‚Üí Kh√¥ng c√≥ l·ªánh t·ª± do ·ªü gi·ªØa.<br>
                        <strong>Khuy·∫øn ngh·ªã:</strong> T·∫°o GAP 2-3 l·ªánh.
                    </div>
                `;
            }
            
            // Optimal
            if (strategy.hedgePercent >= 80 && strategy.hedgePercent <= 85 && 
                strategy.levels.length === 3 && strategy.levels[0] >= 10) {
                html += `
                    <div class="alert success">
                        <strong>‚úÖ Chi·∫øn l∆∞·ª£c t·ªëi ∆∞u!</strong><br>
                        ‚Ä¢ ${strategy.levels.length} t·∫ßng ‚úÖ<br>
                        ‚Ä¢ B·∫Øt ƒë·∫ßu level ${strategy.levels[0]} ‚úÖ<br>
                        ‚Ä¢ Hedge ${strategy.hedgePercent.toFixed(1)}% (80-85% t·ªëi ∆∞u) ‚úÖ<br>
                        ‚Ä¢ NET ${strategy.netLot.toFixed(2)} lot (${(100 - strategy.hedgePercent).toFixed(1)}%) ‚úÖ<br>
                        ‚Ä¢ C√≥ GAP ‚Üí D·ªÖ tho√°t ‚úÖ
                    </div>
                `;
            } else if (strategy.hedgePercent > 90) {
                html += `
                    <div class="alert warning">
                        <strong>‚ö†Ô∏è Hedge qu√° n·∫∑ng (${strategy.hedgePercent.toFixed(1)}%)</strong><br>
                        NET ch·ªâ ${strategy.netLot.toFixed(2)} lot ‚Üí Profit s·∫Ω r·∫•t nh·ªè.
                    </div>
                `;
            } else if (strategy.hedgePercent < 75) {
                html += `
                    <div class="alert warning">
                        <strong>‚ö†Ô∏è Hedge qu√° nh·∫π (${strategy.hedgePercent.toFixed(1)}%)</strong><br>
                        Kh√¥ng ƒë·ªß c√¢n b·∫±ng 2 chi·ªÅu. TƒÉng l√™n 80-85%.
                    </div>
                `;
            }
            
            document.getElementById('warnings').innerHTML = html;
        }
    </script>
</body>
</html>
